<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Educational hearing test with interactive audiogram, PDF report and hearing health content. For the whole family.">
  <meta name="short-description" content="Educational hearing test with interactive audiogram and PDF report.">
  <meta name="icon" content="&#x1f442;">
  <title>Hearing Test | McMinsky</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/T27BCpJj/logo-without-text.png">
  <link rel="stylesheet" href="../../css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@latest/dist/jspdf.umd.min.js"></script>
  <style>
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      padding: calc(var(--header-height) + var(--space-lg)) var(--space-sm) var(--space-xl);
    }
    .screen { display: none; }
    .screen.active { display: block; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

    .test-header { text-align: center; margin-bottom: var(--space-xl); }
    .test-header h1 {
      font-family: var(--font-display);
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      color: var(--white);
      margin-bottom: var(--space-sm);
    }
    .test-header h1 strong { color: var(--gold); }
    .test-intro {
      color: var(--white-dim);
      font-size: 0.95rem;
      line-height: 1.6;
      max-width: 600px;
      margin: 0 auto var(--space-md);
    }
    .badge-disclaimer {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.3);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--gold);
      margin-bottom: var(--space-md);
    }
    .card {
      background: var(--black-lighter);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
    }
    .primary-btn {
      display: inline-block;
      padding: var(--space-sm) var(--space-lg);
      background: var(--gold);
      color: var(--black);
      border: none;
      border-radius: 6px;
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .primary-btn:hover { background: var(--gold-light); transform: translateY(-2px); }
    .primary-btn:active { transform: scale(0.98); }
    .primary-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .outline-btn {
      display: inline-block;
      padding: var(--space-sm) var(--space-lg);
      background: transparent;
      color: var(--gold);
      border: 1px solid var(--gold);
      border-radius: 6px;
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .outline-btn:hover { background: rgba(212, 175, 55, 0.1); }
    .section-title {
      font-family: var(--font-display);
      color: var(--gold);
      font-size: 1.1rem;
      margin-bottom: var(--space-md);
    }
    .input-field {
      width: 100%;
      padding: var(--space-sm);
      background: var(--black);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: var(--white);
      font-size: 1rem;
      margin-bottom: var(--space-md);
      box-sizing: border-box;
    }
    .input-field:focus { outline: none; border-color: var(--gold); }
    .input-label {
      display: block;
      color: var(--white);
      font-family: var(--font-display);
      margin-bottom: var(--space-xs);
      font-size: 0.9rem;
    }
    .animal-chart-wrap { margin-bottom: var(--space-lg); }
    .animal-chart-wrap canvas { width: 100% !important; max-height: 360px; }
    .carousel { position: relative; margin-bottom: var(--space-lg); overflow: hidden; }
    .carousel-track { display: flex; transition: transform 0.4s ease; will-change: transform; }
    .carousel-slide { min-width: 100%; box-sizing: border-box; padding: 0 4px; }
    .fact-card {
      background: var(--black-lighter);
      border: 2px solid rgba(212, 175, 55, 0.25);
      border-radius: 12px;
      padding: var(--space-lg);
      text-align: center;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .fact-emoji { font-size: 2rem; margin-bottom: var(--space-sm); }
    .fact-title { font-family: var(--font-display); color: var(--gold); font-size: 1rem; margin-bottom: var(--space-sm); }
    .fact-text { color: var(--white-dim); font-size: 0.88rem; line-height: 1.55; }
    .carousel-nav { display: flex; justify-content: center; align-items: center; gap: var(--space-sm); margin-top: var(--space-sm); }
    .carousel-arrow {
      background: rgba(212, 175, 55, 0.15);
      border: 1px solid rgba(212, 175, 55, 0.3);
      color: var(--gold);
      width: 36px; height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: background 0.2s;
    }
    .carousel-arrow:hover { background: rgba(212, 175, 55, 0.25); }
    .carousel-dots { display: flex; gap: 6px; }
    .carousel-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; transition: background 0.2s; padding: 0; }
    .carousel-dot.active { background: var(--gold); }
    .form-row { display: flex; gap: var(--space-md); flex-wrap: wrap; }
    .form-row > * { flex: 1; min-width: 140px; }
    .calibration-card { text-align: center; max-width: 500px; margin: 0 auto; }
    .instruction-list { list-style: none; padding: 0; margin: 0 0 var(--space-lg); text-align: left; }
    .instruction-list li { display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm) 0; color: var(--white); font-size: 0.95rem; }
    .instruction-icon { width: 36px; height: 36px; background: rgba(212, 175, 55, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
    .play-cal-btn { width: 80px; height: 80px; border-radius: 50%; background: var(--gold); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-md); transition: all 0.3s ease; position: relative; }
    .play-cal-btn:hover { transform: scale(1.05); background: var(--gold-light); }
    .play-cal-btn svg { width: 32px; height: 32px; fill: var(--black); }
    .wave-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--gold); opacity: 0; animation: none; }
    .play-cal-btn.playing .wave-ring { animation: waveExpand 1.5s ease-out infinite; }
    .play-cal-btn.playing .wave-ring:nth-child(2) { animation-delay: 0.5s; }
    .play-cal-btn.playing .wave-ring:nth-child(3) { animation-delay: 1s; }
    @keyframes waveExpand { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(1.8); opacity: 0; } }
    .cal-slider-wrap { max-width: 300px; margin: 0 auto var(--space-lg); }
    .cal-slider-label { color: var(--white-dim); font-size: 0.85rem; margin-bottom: var(--space-xs); }
    .test-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-sm); }
    .ear-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-family: var(--font-display); font-size: 0.85rem; font-weight: 600; }
    .ear-badge.right { background: rgba(220, 50, 50, 0.15); color: #ef4444; border: 1px solid rgba(220, 50, 50, 0.3); }
    .ear-badge.left { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
    .progress-text { color: var(--white-dim); font-family: var(--font-display); font-size: 0.9rem; }
    .progress-bar-wrap { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-bottom: var(--space-lg); }
    .progress-bar-fill { height: 100%; background: var(--gold); border-radius: 2px; transition: width 0.4s ease; }
    .freq-display { text-align: center; margin-bottom: var(--space-md); }
    .freq-number { font-family: var(--font-display); font-size: clamp(2.5rem, 8vw, 4rem); color: var(--white); line-height: 1; }
    .freq-unit { color: var(--white-dim); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; }
    .play-tone-btn { width: 100px; height: 100px; border-radius: 50%; background: rgba(212, 175, 55, 0.15); border: 2px solid var(--gold); cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-md); transition: all 0.3s ease; position: relative; }
    .play-tone-btn:hover { background: rgba(212, 175, 55, 0.25); }
    .play-tone-btn.playing { background: rgba(212, 175, 55, 0.3); }
    .play-tone-btn svg { width: 36px; height: 36px; fill: var(--gold); }
    .play-tone-btn .wave-ring { border-color: var(--gold); }
    .play-tone-btn.playing .wave-ring { animation: waveExpand 1.5s ease-out infinite; }
    .play-tone-btn.playing .wave-ring:nth-child(2) { animation-delay: 0.5s; }
    .play-tone-btn.playing .wave-ring:nth-child(3) { animation-delay: 1s; }
    .tone-instructions { text-align: center; color: var(--white-dim); font-size: 0.85rem; margin-bottom: var(--space-md); }
    .vol-slider-wrap { max-width: 350px; margin: 0 auto var(--space-lg); }
    .vol-slider-labels { display: flex; justify-content: space-between; color: var(--white-dim); font-size: 0.75rem; margin-top: 4px; }
    .vol-level { text-align: center; color: var(--gold); font-family: var(--font-display); font-size: 0.9rem; margin-top: var(--space-xs); }
    .action-btns { display: flex; gap: var(--space-md); justify-content: center; flex-wrap: wrap; margin-bottom: var(--space-lg); }
    .action-btns .primary-btn, .action-btns .outline-btn { min-width: 140px; text-align: center; }
    .mini-audiogram-wrap { margin-top: var(--space-md); cursor: pointer; position: relative; }
    .mini-audiogram-wrap canvas { width: 100% !important; max-height: 180px; }
    .mini-audiogram-hint { text-align: center; color: var(--white-dim); font-size: 0.75rem; margin-top: 4px; }
    .ear-transition { display: none; text-align: center; padding: var(--space-xl) 0; }
    .ear-transition.active { display: block; animation: fadeIn 0.5s ease; }
    .ear-transition h2 { font-family: var(--font-display); color: var(--white); font-size: 1.5rem; margin-bottom: var(--space-sm); }
    .ear-transition p { color: var(--white-dim); }
    .audiogram-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 1000; padding: var(--space-lg); overflow-y: auto; }
    .audiogram-overlay.active { display: flex; align-items: center; justify-content: center; }
    .audiogram-overlay-inner { width: 100%; max-width: 600px; }
    .audiogram-overlay canvas { width: 100% !important; max-height: 70vh; }
    .audiogram-overlay-close { position: absolute; top: var(--space-md); right: var(--space-md); background: none; border: 1px solid var(--gold); color: var(--gold); width: 36px; height: 36px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; }
    .audiogram-full-wrap { margin-bottom: var(--space-lg); }
    .audiogram-full-wrap canvas { width: 100% !important; max-height: 400px; }
    .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md); margin-bottom: var(--space-lg); }
    .summary-card { background: rgba(255,255,255,0.03); padding: var(--space-md); border-radius: 8px; text-align: center; }
    .summary-value { font-family: var(--font-display); font-size: 1.8rem; color: var(--white); line-height: 1.1; margin-bottom: 4px; }
    .summary-label { color: var(--white-dim); font-size: 0.78rem; text-transform: uppercase; letter-spacing: 1px; }
    .summary-card.right .summary-value { color: #ef4444; }
    .summary-card.left .summary-value { color: #3b82f6; }
    .interpretation-panel { background: rgba(212, 175, 55, 0.05); border-left: 3px solid var(--gold); padding: var(--space-md); margin-bottom: var(--space-lg); border-radius: 0 8px 8px 0; }
    .interpretation-panel h3 { font-family: var(--font-display); color: var(--gold); margin-bottom: var(--space-sm); font-size: 1rem; }
    .interpretation-panel p { color: var(--white-dim); font-size: 0.9rem; line-height: 1.6; margin-bottom: var(--space-sm); }
    .asha-scale { margin-bottom: var(--space-lg); }
    .asha-scale-title { font-family: var(--font-display); color: var(--white); font-size: 0.9rem; margin-bottom: var(--space-sm); }
    .asha-bar { position: relative; height: 24px; border-radius: 12px; background: linear-gradient(to right, #22c55e 0%, #22c55e 15%, #84cc16 15%, #84cc16 25%, #eab308 25%, #eab308 40%, #f97316 40%, #f97316 55%, #ef4444 55%, #ef4444 70%, #dc2626 70%, #dc2626 90%, #7f1d1d 90%); margin-bottom: 6px; }
    .asha-marker { position: absolute; top: -6px; width: 3px; height: 36px; background: var(--white); border-radius: 2px; transition: left 0.5s ease; }
    .asha-marker::after { content: attr(data-label); position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; color: var(--white); white-space: nowrap; }
    .asha-labels { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--white-dim); }
    .disclaimer-box { background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: var(--space-md); margin-bottom: var(--space-lg); }
    .disclaimer-box h4 { color: #ef4444; font-family: var(--font-display); font-size: 0.9rem; margin-bottom: var(--space-xs); }
    .disclaimer-box p { color: var(--white-dim); font-size: 0.82rem; line-height: 1.5; }
    .result-btns { display: flex; gap: var(--space-md); justify-content: center; flex-wrap: wrap; }
    input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; outline: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; border-radius: 50%; background: var(--gold); cursor: pointer; border: none; }
    input[type="range"]::-moz-range-thumb { width: 22px; height: 22px; border-radius: 50%; background: var(--gold); cursor: pointer; border: none; }
    @media (max-width: 480px) {
      .summary-grid { grid-template-columns: 1fr 1fr; gap: var(--space-sm); }
      .form-row { flex-direction: column; }
      .action-btns { flex-direction: column; align-items: center; }
      .action-btns .primary-btn, .action-btns .outline-btn { width: 100%; }
    }
  </style>
</head>
<body class="loading">
  <div class="loader">
    <img src="https://i.postimg.cc/T27BCpJj/logo-without-text.png" alt="McMinsky" class="loader-logo">
    <span class="loader-text">McMinsky</span>
    <div class="loader-bar"></div>
  </div>

  <header class="header">
    <div class="header-inner">
      <a href="/en/" class="logo">
        <img src="https://i.postimg.cc/T27BCpJj/logo-without-text.png" alt="McMinsky Logo">
        <span class="logo-text">McMinsky</span>
      </a>
      <button class="nav-toggle" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
      <nav class="nav">
        <ul class="nav-list">
          <li class="nav-item"><a href="/en/" class="nav-link">Home</a></li>
          <li class="nav-item"><a href="/en/#programs" class="nav-link">Programs</a></li>
          <li class="nav-item"><a href="/en/#tools" class="nav-link">Tools</a></li>
          <li class="nav-item"><a href="/en/#contact" class="nav-link">Contact</a></li>
        </ul>
        <div class="lang-switch">
          <button class="lang-btn" data-lang="pt">PT</button>
          <button class="lang-btn active" data-lang="en">EN</button>
        </div>
      </nav>
    </div>
  </header>

  <div class="test-container">

    <!-- ========== SCREEN 1: INTRO ========== -->
    <div class="screen active" id="screen-intro">
      <div class="test-header">
        <h1><strong>Hearing</strong> Test</h1>
        <p class="test-intro">Discover how your hearing is doing with this interactive educational test. Test different frequencies, get your personal audiogram and learn about hearing health.</p>
        <span class="badge-disclaimer">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/></svg>
          For educational purposes only &mdash; no clinical validity
        </span>
      </div>

      <div class="card animal-chart-wrap">
        <h3 class="section-title">Hearing Range in the Animal Kingdom</h3>
        <canvas id="animal-chart"></canvas>
      </div>

      <div class="carousel" id="fact-carousel">
        <div class="carousel-track" id="carousel-track"></div>
        <div class="carousel-nav">
          <button class="carousel-arrow" id="carousel-prev" aria-label="Previous">&#8249;</button>
          <div class="carousel-dots" id="carousel-dots"></div>
          <button class="carousel-arrow" id="carousel-next" aria-label="Next">&#8250;</button>
        </div>
      </div>

      <div class="card">
        <h3 class="section-title">Your Details</h3>
        <div class="form-row">
          <div>
            <label class="input-label" for="user-name">Name</label>
            <input type="text" class="input-field" id="user-name" placeholder="Your name" maxlength="60">
          </div>
          <div>
            <label class="input-label" for="user-age">Age</label>
            <input type="number" class="input-field" id="user-age" placeholder="E.g.: 25" min="3" max="120">
          </div>
        </div>
        <div style="text-align:center; margin-top: var(--space-md);">
          <button class="primary-btn" id="btn-start">Start Test</button>
        </div>
      </div>
    </div>

    <!-- ========== SCREEN 2: CALIBRATION ========== -->
    <div class="screen" id="screen-calibration">
      <div class="test-header">
        <h1>Calibration</h1>
        <p class="test-intro">Before we begin, let's calibrate the volume to ensure reliable results.</p>
      </div>
      <div class="card calibration-card">
        <ul class="instruction-list">
          <li><span class="instruction-icon">&#127911;</span><span>Use headphones (strongly recommended)</span></li>
          <li><span class="instruction-icon">&#128264;</span><span>Go to a quiet environment</span></li>
          <li><span class="instruction-icon">&#128266;</span><span>Set your device volume to ~50%</span></li>
        </ul>
        <p style="color: var(--white-dim); font-size: 0.88rem; margin-bottom: var(--space-md);">Press the button to hear a 1000 Hz tone. Adjust the slider until you hear it <strong style="color: var(--white);">comfortably</strong>.</p>
        <button class="play-cal-btn" id="btn-cal-play" aria-label="Play calibration tone">
          <span class="wave-ring"></span><span class="wave-ring"></span><span class="wave-ring"></span>
          <svg viewBox="0 0 24 24"><polygon points="6,4 20,12 6,20"/></svg>
        </button>
        <div class="cal-slider-wrap">
          <div class="cal-slider-label">Calibration volume</div>
          <input type="range" id="cal-slider" min="0" max="100" value="50">
          <div class="vol-level" id="cal-level">50%</div>
        </div>
        <button class="primary-btn" id="btn-cal-ready">I'm Ready</button>
      </div>
    </div>

    <!-- ========== SCREEN 3: TEST ========== -->
    <div class="screen" id="screen-test">
      <div class="test-top-bar">
        <span class="ear-badge right" id="ear-badge">&#128066; Right Ear</span>
        <span class="progress-text" id="progress-text">1 / 9</span>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progress-bar" style="width: 0%"></div>
      </div>

      <div class="freq-display">
        <div class="freq-number" id="freq-number">1000</div>
        <div class="freq-unit">Hz</div>
      </div>

      <button class="play-tone-btn" id="btn-play-tone" aria-label="Play tone">
        <span class="wave-ring"></span><span class="wave-ring"></span><span class="wave-ring"></span>
        <svg viewBox="0 0 24 24"><polygon points="6,4 20,12 6,20"/></svg>
      </button>
      <p class="tone-instructions" id="tone-instructions">Press to play the tone. Adjust the volume until you can barely hear it.</p>

      <div id="vol-section">
        <div class="vol-slider-wrap">
          <input type="range" id="vol-slider" min="0" max="100" value="50">
          <div class="vol-slider-labels"><span>Quieter</span><span>Louder</span></div>
          <div class="vol-level" id="vol-level">50</div>
        </div>
      </div>

      <div class="action-btns">
        <button class="primary-btn" id="btn-hear">I can (barely) hear it</button>
        <button class="outline-btn" id="btn-no-hear">I can't hear it</button>
      </div>

      <div class="ear-transition" id="ear-transition">
        <h2>Right Ear complete!</h2>
        <p>Now let's test the <strong style="color: #3b82f6;">Left Ear</strong>.</p>
        <div style="margin-top: var(--space-lg);">
          <button class="primary-btn" id="btn-start-left">Continue</button>
        </div>
      </div>

      <div class="mini-audiogram-wrap" id="mini-audiogram-wrap">
        <canvas id="mini-audiogram"></canvas>
        <p class="mini-audiogram-hint">Tap to enlarge the audiogram</p>
      </div>
    </div>

    <!-- ========== AUDIOGRAM OVERLAY ========== -->
    <div class="audiogram-overlay" id="audiogram-overlay">
      <button class="audiogram-overlay-close" id="overlay-close" aria-label="Close">&times;</button>
      <div class="audiogram-overlay-inner">
        <canvas id="overlay-audiogram"></canvas>
      </div>
    </div>

    <!-- ========== SCREEN 4: RESULTS ========== -->
    <div class="screen" id="screen-results">
      <div class="test-header">
        <h1>Results</h1>
        <p class="test-intro" id="results-subtitle">Audiogram of —</p>
      </div>

      <div class="card audiogram-full-wrap">
        <canvas id="full-audiogram"></canvas>
      </div>

      <div class="summary-grid">
        <div class="summary-card right">
          <div class="summary-value" id="pta-right">—</div>
          <div class="summary-label">PTA Right (dB)</div>
        </div>
        <div class="summary-card left">
          <div class="summary-value" id="pta-left">—</div>
          <div class="summary-label">PTA Left (dB)</div>
        </div>
        <div class="summary-card right">
          <div class="summary-value" id="class-right" style="font-size:1.1rem;">—</div>
          <div class="summary-label">Classification R.</div>
        </div>
        <div class="summary-card left">
          <div class="summary-value" id="class-left" style="font-size:1.1rem;">—</div>
          <div class="summary-label">Classification L.</div>
        </div>
      </div>

      <div class="card" style="border-color: rgba(212,175,55,0.2);">
        <h3 class="section-title">Audible Frequency Range</h3>
        <div class="summary-grid" style="margin-bottom:0;">
          <div class="summary-card right">
            <div class="summary-value" id="range-right" style="font-size:1rem;">—</div>
            <div class="summary-label">Right Ear</div>
          </div>
          <div class="summary-card left">
            <div class="summary-value" id="range-left" style="font-size:1rem;">—</div>
            <div class="summary-label">Left Ear</div>
          </div>
        </div>
      </div>

      <div class="interpretation-panel" id="interpretation-panel">
        <h3>Interpretation</h3>
        <p id="interpretation-text"></p>
      </div>

      <div class="asha-scale">
        <div class="asha-scale-title">ASHA Scale (average of both ears)</div>
        <div class="asha-bar">
          <div class="asha-marker" id="asha-marker" data-label="" style="left: 0%"></div>
        </div>
        <div class="asha-labels">
          <span>Normal</span><span>Slight</span><span>Mild</span><span>Moderate</span><span>Severe</span><span>Profound</span>
        </div>
      </div>

      <div class="disclaimer-box">
        <h4>Important Notice</h4>
        <p>This test is <strong>for educational purposes only</strong> and does not replace a professional audiological assessment. The values shown are relative to your device's calibration level and do not correspond to clinically calibrated dB HL (decibels hearing level). If you suspect hearing loss, please consult an ENT specialist or audiologist.</p>
      </div>

      <div class="result-btns">
        <button class="primary-btn" id="btn-pdf">Download PDF</button>
        <button class="outline-btn" id="btn-restart">Retake Test</button>
      </div>
    </div>

  </div>

  <footer class="footer">
    <div class="footer-bottom">
      <div class="footer-legal">
        <a href="../../legal/en/terms.html">Terms & Conditions</a>
        <a href="../../legal/en/privacy.html">Privacy Policy</a>
        <a href="https://www.livroreclamacoes.pt/inicio/reclamacao?nipc=517747120" target="_blank">Complaints Book</a>
      </div>
      <p class="footer-copyright">&copy; <span class="current-year">2025</span> McMinsky. All rights reserved.</p>
    </div>
  </footer>

  <script src="../../js/main.js"></script>
  <script>
  (function() {
    'use strict';
    var $ = function(id) { return document.getElementById(id); };

    function showScreen(id) {
      var screens = document.querySelectorAll('.screen');
      for (var i = 0; i < screens.length; i++) screens[i].classList.remove('active');
      $(id).classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function trackAction(action, extra) {
      if (typeof mcmTrack === 'function') mcmTrack(action, extra || '');
    }

    /* ============ DATA ============ */
    var STANDARD_FREQS = [1000, 2000, 3000, 4000, 6000, 8000, 500, 250, 125];
    var FREQ_LABELS = [125, 250, 500, 1000, 2000, 3000, 4000, 6000, 8000];
    var PTA_FREQS = [500, 1000, 2000, 4000];
    var HIGH_EXT = [10000, 12000, 14000, 16000, 18000, 20000];
    var LOW_EXT = [100, 80, 60];
    var EXT_VOLUME = 75;

    var facts = [
      { emoji: '&#127820;', title: 'The Speech Banana', text: 'On a clinical audiogram, human speech sounds occupy a banana-shaped zone between 250-6000 Hz and 20-50 dB. If your hearing falls outside this zone, you may have difficulty understanding conversations.' },
      { emoji: '&#129528;', title: 'Sensorineural vs. Conductive', text: 'Conductive loss (outer/middle ear) can be treated surgically. Sensorineural loss (cochlea/nerve) is usually permanent and requires hearing aids or implants.' },
      { emoji: '&#128164;', title: 'Auditory Fatigue', text: 'After prolonged noise exposure (concerts, factories), your hearing threshold rises temporarily. If it happens often, the damage becomes permanent.' },
      { emoji: '&#128065;', title: 'Hidden Hearing Loss', text: 'You can have a normal audiogram and still struggle to understand speech in noisy environments. It\'s called cochlear synaptopathy — the synapses between hair cells and the nerve are damaged.' },
      { emoji: '&#129504;', title: 'Ear-Brain Link & Dementia', text: 'Lancet studies estimate that untreated hearing loss is the largest modifiable risk factor for dementia, accounting for up to 8% of cases. Treating hearing can protect the brain.' },
      { emoji: '&#129516;', title: 'Cells That Don\'t Regrow', text: 'Humans are born with ~15,000 hair cells per ear. Unlike birds and reptiles, ours do not regenerate. Each lost cell is permanent.' },
      { emoji: '&#128680;', title: 'Sudden Deafness', text: 'Sudden hearing loss (within hours/days) is a medical emergency. Treatment with corticosteroids within the first 72 hours can restore hearing. Don\'t wait!' },
      { emoji: '&#9878;&#65039;', title: 'Asymmetric Loss', text: 'A significant difference between the two ears may indicate an acoustic neuroma (benign tumour). It\'s a red flag that warrants an MRI scan.' },
      { emoji: '&#128147;', title: 'Pulsatile Tinnitus', text: 'A ringing that beats in time with your heartbeat (pulsatile) is different from common tinnitus. It may indicate a vascular anomaly and should be investigated urgently.' },
      { emoji: '&#128116;', title: 'Presbycusis', text: 'From age 30 onwards, everyone progressively loses hearing in high frequencies. By 65, 1 in 3 people has significant hearing loss. It\'s the natural ageing of the cochlea.' },
      { emoji: '&#128557;', title: 'The Isolation Epidemic', text: 'Untreated hearing loss is associated with social isolation, depression and accelerated cognitive decline. People avoid conversations and social events out of embarrassment or frustration.' },
      { emoji: '&#127758;', title: 'The 1 in 3 Rule (WHO)', text: 'The WHO estimates that more than 1 in 3 people over 65 have disabling hearing loss. And over a billion young people are at risk due to unsafe listening practices.' }
    ];

    var animalData = [
      { name: 'Human', min: 20, max: 20000, color: 'rgba(212,175,55,0.85)' },
      { name: 'Dog', min: 67, max: 45000, color: 'rgba(139,92,246,0.75)' },
      { name: 'Cat', min: 48, max: 85000, color: 'rgba(244,114,182,0.75)' },
      { name: 'Bat', min: 2000, max: 110000, color: 'rgba(99,102,241,0.75)' },
      { name: 'Dolphin', min: 150, max: 150000, color: 'rgba(34,211,238,0.75)' },
      { name: 'Elephant', min: 5, max: 12000, color: 'rgba(248,113,113,0.75)' },
      { name: 'Owl', min: 200, max: 12000, color: 'rgba(251,191,36,0.75)' },
      { name: 'Mouse', min: 1000, max: 91000, color: 'rgba(74,222,128,0.75)' }
    ];

    /* ============ STATE ============ */
    var userName = '', userAge = 0, calibrationGain = 0.05;
    var audioCtx = null, currentOsc = null, currentGain = null, currentPanner = null, isPlaying = false;
    var testEar = 'right';
    var testPhase = 'standard';
    var freqIndex = 0, currentFreq = 1000;
    var thresholds = { right: {}, left: {} };
    var extIdx = 0, bisectLo = 0, bisectHi = 0, bisectCount = 0;
    var hearingRange = { right: { max: 8000, min: 125 }, left: { max: 8000, min: 125 } };

    /* ============ AUDIO ENGINE ============ */
    function initAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    function playTone(freq, gainValue, pan) {
      stopTone(); initAudio();
      currentOsc = audioCtx.createOscillator();
      currentGain = audioCtx.createGain();
      currentPanner = audioCtx.createStereoPanner();
      currentOsc.type = 'sine';
      currentOsc.frequency.value = freq;
      currentGain.gain.setValueAtTime(0, audioCtx.currentTime);
      currentGain.gain.linearRampToValueAtTime(gainValue, audioCtx.currentTime + 0.005);
      currentPanner.pan.value = pan;
      currentOsc.connect(currentGain);
      currentGain.connect(currentPanner);
      currentPanner.connect(audioCtx.destination);
      currentOsc.start();
      isPlaying = true;
    }
    function stopTone() {
      if (currentGain && audioCtx) { try { currentGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.005); } catch(e) {} }
      if (currentOsc) { try { currentOsc.stop(audioCtx.currentTime + 0.01); } catch(e) {} currentOsc = null; }
      currentGain = null; currentPanner = null; isPlaying = false;
    }

    /* FIX 1: Correct dB mapping — lower slider = lower dB = better hearing = point near top */
    function calSliderToGain(v) {
      if (v <= 0) return 0;
      return 0.5 * Math.pow(v / 100, 2);
    }
    function sliderToGain(v) {
      if (v <= 0) return 0;
      return calibrationGain * Math.pow(10, (v - 50) / 20);
    }
    function gainToRelativeDb(g) {
      if (g <= 0) return -10;
      if (calibrationGain <= 0) return 100;
      var db = Math.round(20 * Math.log10(g / calibrationGain));
      return Math.min(100, Math.max(-10, db));
    }
    function roundFreq(f) {
      if (f >= 10000) return Math.round(f / 500) * 500;
      if (f >= 1000) return Math.round(f / 100) * 100;
      if (f >= 100) return Math.round(f / 10) * 10;
      return Math.round(f / 5) * 5;
    }
    function formatFreq(f) { return f >= 1000 ? (f / 1000) + ' kHz' : f + ' Hz'; }

    /* ============ CLASSIFICATION ============ */
    function classify(pta) {
      if (pta <= 15) return 'Normal';
      if (pta <= 25) return 'Slight';
      if (pta <= 40) return 'Mild';
      if (pta <= 55) return 'Moderate';
      if (pta <= 70) return 'Mod. Severe';
      if (pta <= 90) return 'Severe';
      return 'Profound';
    }
    function computePTA(ear) {
      var s = 0, c = 0;
      for (var i = 0; i < PTA_FREQS.length; i++) {
        if (typeof ear[PTA_FREQS[i]] === 'number') { s += ear[PTA_FREQS[i]]; c++; }
      }
      return c > 0 ? Math.round(s / c) : 0;
    }

    /* ============ ANIMAL CHART ============ */
    function buildAnimalChart() {
      var ctx = $('animal-chart').getContext('2d');
      var labels = [], minD = [], barD = [], colors = [];
      for (var i = 0; i < animalData.length; i++) {
        labels.push(animalData[i].name);
        minD.push(Math.log10(animalData[i].min));
        barD.push(Math.log10(animalData[i].max) - Math.log10(animalData[i].min));
        colors.push(animalData[i].color);
      }
      new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: [
          { label: 'Offset', data: minD, backgroundColor: 'transparent', borderWidth: 0, barPercentage: 0.6 },
          { label: 'Range (Hz)', data: barD, backgroundColor: colors, borderWidth: 0, borderRadius: 4, barPercentage: 0.6 }
        ]},
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: { label: function(c) { var a = animalData[c.dataIndex]; return a.name + ': ' + a.min.toLocaleString() + ' - ' + a.max.toLocaleString() + ' Hz'; } },
              filter: function(item) { return item.datasetIndex === 1; }
            }
          },
          scales: {
            x: {
              stacked: true,
              title: { display: true, text: 'Frequency (Hz) — log scale', color: 'rgba(255,255,255,0.5)', font: { size: 11 } },
              ticks: { color: 'rgba(255,255,255,0.5)', callback: function(v) { var hz = Math.round(Math.pow(10, v)); if (hz >= 1000) return Math.round(hz / 1000) + 'k'; return hz + ''; } },
              grid: { color: 'rgba(255,255,255,0.06)' }, min: 0, max: 5.3
            },
            y: { stacked: true, ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 12 } }, grid: { display: false } }
          }
        }
      });
    }

    /* ============ CAROUSEL ============ */
    function buildCarousel() {
      var track = $('carousel-track'), dotsWrap = $('carousel-dots');
      var shuffled = facts.slice();
      for (var i = shuffled.length - 1; i > 0; i--) { var j = Math.floor(Math.random() * (i + 1)); var t = shuffled[i]; shuffled[i] = shuffled[j]; shuffled[j] = t; }
      var html = '', dh = '';
      for (var k = 0; k < shuffled.length; k++) {
        var f = shuffled[k];
        html += '<div class="carousel-slide"><div class="fact-card"><div class="fact-emoji">' + f.emoji + '</div><div class="fact-title">Did you know? — ' + f.title + '</div><div class="fact-text">' + f.text + '</div></div></div>';
        dh += '<button class="carousel-dot' + (k === 0 ? ' active' : '') + '" data-idx="' + k + '"></button>';
      }
      track.innerHTML = html; dotsWrap.innerHTML = dh;
      var cur = 0, total = shuffled.length, dots = dotsWrap.querySelectorAll('.carousel-dot');
      function goTo(idx) { if (idx < 0) idx = total - 1; if (idx >= total) idx = 0; cur = idx; track.style.transform = 'translateX(-' + (cur * 100) + '%)'; for (var d = 0; d < dots.length; d++) dots[d].classList.toggle('active', d === cur); }
      $('carousel-prev').addEventListener('click', function() { goTo(cur - 1); });
      $('carousel-next').addEventListener('click', function() { goTo(cur + 1); });
      for (var d = 0; d < dots.length; d++) dots[d].addEventListener('click', function() { goTo(parseInt(this.getAttribute('data-idx'))); });
      var startX = 0;
      $('fact-carousel').addEventListener('touchstart', function(e) { startX = e.touches[0].clientX; }, { passive: true });
      $('fact-carousel').addEventListener('touchend', function(e) { var diff = startX - e.changedTouches[0].clientX; if (Math.abs(diff) > 40) goTo(cur + (diff > 0 ? 1 : -1)); }, { passive: true });
    }

    /* ============ AUDIOGRAM CHARTS ============ */
    /* FIX 2: Dynamic frequency labels (includes extension data) */
    function getActiveFreqs() {
      var freqSet = {}, i;
      for (i = 0; i < FREQ_LABELS.length; i++) freqSet[FREQ_LABELS[i]] = true;
      for (var ear in thresholds) {
        for (var f in thresholds[ear]) {
          if (typeof thresholds[ear][f] === 'number') freqSet[parseInt(f)] = true;
        }
      }
      var freqs = [];
      for (var k in freqSet) freqs.push(parseInt(k));
      freqs.sort(function(a, b) { return a - b; });
      return freqs;
    }
    function freqToLabel(f) { return f >= 1000 ? (f / 1000) + 'k' : f + ''; }
    function findFreqIdx(freqs, target) {
      for (var i = 0; i < freqs.length; i++) { if (freqs[i] >= target) return i; }
      return freqs.length - 1;
    }

    var miniChart = null, overlayChart = null, fullChart = null;

    /* FIX 3: Blue line (left ear) thicker + larger markers for visibility when overlapping */
    function getAudiogramConfig(compact) {
      var dynFreqs = getActiveFreqs();
      var rD = [], lD = [];
      for (var i = 0; i < dynFreqs.length; i++) {
        var f = dynFreqs[i];
        rD.push(typeof thresholds.right[f] === 'number' ? thresholds.right[f] : null);
        lD.push(typeof thresholds.left[f] === 'number' ? thresholds.left[f] : null);
      }
      var idx500 = findFreqIdx(dynFreqs, 500);
      var idx6000 = findFreqIdx(dynFreqs, 6000);
      return {
        type: 'line',
        data: {
          labels: dynFreqs.map(freqToLabel),
          datasets: [
            { label: 'Right', data: rD, borderColor: '#ef4444', backgroundColor: '#ef4444', pointStyle: 'circle', pointRadius: compact ? 4 : 6, pointBorderWidth: 2, borderWidth: 2, tension: 0, spanGaps: true },
            { label: 'Left', data: lD, borderColor: '#3b82f6', backgroundColor: '#3b82f6', pointStyle: 'crossRot', pointRadius: compact ? 6 : 9, pointBorderWidth: 3, borderWidth: 3, tension: 0, spanGaps: true }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { display: !compact, labels: { color: 'rgba(255,255,255,0.7)', usePointStyle: true } },
            tooltip: { callbacks: { label: function(c) { return c.dataset.label + ': ' + c.parsed.y + ' dB'; } } },
            annotation: compact ? {} : { annotations: {
              speechBanana: { type: 'box', xMin: idx500, xMax: idx6000, yMin: 20, yMax: 50, backgroundColor: 'rgba(212,175,55,0.08)', borderColor: 'rgba(212,175,55,0.2)', borderWidth: 1, label: { display: true, content: 'Speech Banana', color: 'rgba(212,175,55,0.5)', font: { size: 10 }, position: 'start' } },
              normalLine: { type: 'line', yMin: 20, yMax: 20, borderColor: 'rgba(34,197,94,0.4)', borderWidth: 1, borderDash: [4, 4], label: { display: true, content: 'Normal limit (20 dB)', color: 'rgba(34,197,94,0.5)', font: { size: 9 }, position: 'end' } }
            }}
          },
          scales: {
            x: { title: { display: !compact, text: 'Frequency (Hz)', color: 'rgba(255,255,255,0.5)', font: { size: 11 } }, ticks: { color: 'rgba(255,255,255,0.5)', font: { size: compact ? 9 : 11 } }, grid: { color: 'rgba(255,255,255,0.06)' } },
            y: { title: { display: !compact, text: 'Hearing Level (dB)', color: 'rgba(255,255,255,0.5)', font: { size: 11 } }, reverse: true, min: -10, max: 100, ticks: { color: 'rgba(255,255,255,0.5)', stepSize: compact ? 20 : 10, font: { size: compact ? 9 : 11 } }, grid: { color: 'rgba(255,255,255,0.06)' } }
          }
        }
      };
    }
    /* Destroy & recreate charts since labels change dynamically */
    function updateMiniAudiogram() {
      if (miniChart) { miniChart.destroy(); miniChart = null; }
      miniChart = new Chart($('mini-audiogram').getContext('2d'), getAudiogramConfig(true));
    }
    function updateOverlayAudiogram() {
      if (overlayChart) { overlayChart.destroy(); overlayChart = null; }
      overlayChart = new Chart($('overlay-audiogram').getContext('2d'), getAudiogramConfig(false));
    }
    function buildFullAudiogram() {
      if (fullChart) { fullChart.destroy(); fullChart = null; }
      fullChart = new Chart($('full-audiogram').getContext('2d'), getAudiogramConfig(false));
    }

    /* ============ SCREEN 1 ============ */
    $('btn-start').addEventListener('click', function() {
      userName = ($('user-name').value || '').trim() || 'User';
      userAge = parseInt($('user-age').value) || 0;
      showScreen('screen-calibration');
    });

    /* ============ SCREEN 2: CALIBRATION (uses calSliderToGain) ============ */
    var calPlaying = false;
    $('cal-slider').addEventListener('input', function() {
      var v = parseInt(this.value); $('cal-level').textContent = v + '%';
      if (calPlaying && currentGain && audioCtx) currentGain.gain.linearRampToValueAtTime(calSliderToGain(v), audioCtx.currentTime + 0.02);
    });
    $('btn-cal-play').addEventListener('click', function() {
      initAudio();
      if (calPlaying) { stopTone(); calPlaying = false; this.classList.remove('playing'); }
      else { playTone(1000, calSliderToGain(parseInt($('cal-slider').value)), 0); calPlaying = true; this.classList.add('playing'); }
    });
    $('btn-cal-ready').addEventListener('click', function() {
      stopTone(); calPlaying = false; $('btn-cal-play').classList.remove('playing');
      calibrationGain = calSliderToGain(parseInt($('cal-slider').value));
      if (calibrationGain < 0.0001) calibrationGain = 0.0001;
      testEar = 'right'; testPhase = 'standard'; freqIndex = 0;
      thresholds = { right: {}, left: {} };
      hearingRange = { right: { max: 8000, min: 125 }, left: { max: 8000, min: 125 } };
      trackAction('Hearing Test: start');
      showScreen('screen-test');
      showCurrentStep();
      updateMiniAudiogram();
    });

    /* ============ SCREEN 3: TEST ============ */
    function isExtPhase() { return testPhase !== 'standard'; }

    function getCurrentTestFreq() {
      switch (testPhase) {
        case 'standard': return STANDARD_FREQS[freqIndex];
        case 'high-ext': return HIGH_EXT[extIdx];
        case 'high-bisect': return roundFreq((bisectLo + bisectHi) / 2);
        case 'low-ext': return LOW_EXT[extIdx];
        case 'low-bisect': return roundFreq((bisectLo + bisectHi) / 2);
      }
    }

    function showCurrentStep() {
      currentFreq = getCurrentTestFreq();
      $('freq-number').textContent = currentFreq;
      $('ear-transition').classList.remove('active');
      stopTone(); $('btn-play-tone').classList.remove('playing');

      var badge = $('ear-badge');
      if (testEar === 'right') { badge.className = 'ear-badge right'; badge.innerHTML = '&#128066; Right Ear'; }
      else { badge.className = 'ear-badge left'; badge.innerHTML = '&#128067; Left Ear'; }

      var totalStd = STANDARD_FREQS.length * 2;
      if (testPhase === 'standard') {
        var step = (testEar === 'right' ? 0 : STANDARD_FREQS.length) + freqIndex + 1;
        $('progress-text').textContent = step + ' / ' + totalStd + '+';
        $('progress-bar').style.width = (step / totalStd * 85) + '%';
      } else {
        var phaseLabels = { 'high-ext': 'Extension: high freq.', 'high-bisect': 'Fine-tuning: upper limit', 'low-ext': 'Extension: low freq.', 'low-bisect': 'Fine-tuning: lower limit' };
        $('progress-text').textContent = phaseLabels[testPhase] || '';
        $('progress-bar').style.width = (testEar === 'right' ? 46 : 92) + '%';
      }

      if (isExtPhase()) {
        $('vol-section').style.display = 'none';
        $('tone-instructions').textContent = 'Press to listen. The tone plays at fixed volume — just indicate if you can hear it or not.';
        $('btn-hear').textContent = 'I hear it';
      } else {
        $('vol-section').style.display = '';
        $('tone-instructions').textContent = 'Press to play the tone. Adjust the volume until you can barely hear it.';
        $('btn-hear').textContent = 'I can (barely) hear it';
        $('vol-slider').value = 50; $('vol-level').textContent = '50';
      }
    }

    $('btn-play-tone').addEventListener('click', function() {
      initAudio();
      if (isPlaying) { stopTone(); this.classList.remove('playing'); return; }
      var gain = isExtPhase() ? sliderToGain(EXT_VOLUME) : sliderToGain(parseInt($('vol-slider').value));
      playTone(currentFreq, gain, testEar === 'right' ? 1 : -1);
      this.classList.add('playing');
    });

    $('vol-slider').addEventListener('input', function() {
      var v = parseInt(this.value); $('vol-level').textContent = v;
      if (isPlaying && !isExtPhase() && currentGain && audioCtx) currentGain.gain.linearRampToValueAtTime(sliderToGain(v), audioCtx.currentTime + 0.02);
    });

    function recordResponse(heard) {
      stopTone(); $('btn-play-tone').classList.remove('playing');
      switch (testPhase) {
        case 'standard': recordStandard(heard); break;
        case 'high-ext': recordHighExt(heard); break;
        case 'high-bisect': recordHighBisect(heard); break;
        case 'low-ext': recordLowExt(heard); break;
        case 'low-bisect': recordLowBisect(heard); break;
      }
      updateMiniAudiogram();
    }

    function recordStandard(heard) {
      var freq = STANDARD_FREQS[freqIndex];
      if (heard) { thresholds[testEar][freq] = gainToRelativeDb(sliderToGain(parseInt($('vol-slider').value))); }
      else { thresholds[testEar][freq] = 100; }
      freqIndex++;
      if (freqIndex >= STANDARD_FREQS.length) { initHearingRange(); checkHighExtension(); }
      else { showCurrentStep(); }
    }

    function initHearingRange() {
      var maxF = 125, minF = 8000;
      for (var i = 0; i < STANDARD_FREQS.length; i++) {
        var f = STANDARD_FREQS[i];
        if (thresholds[testEar][f] < 80) { if (f > maxF) maxF = f; if (f < minF) minF = f; }
      }
      hearingRange[testEar].max = maxF;
      hearingRange[testEar].min = minF;
    }

    function checkHighExtension() {
      if (thresholds[testEar][8000] < 80) { testPhase = 'high-ext'; extIdx = 0; showCurrentStep(); }
      else { checkLowExtension(); }
    }

    /* Extension records thresholds so they appear on the audiogram */
    function recordHighExt(heard) {
      var freq = HIGH_EXT[extIdx];
      if (heard) {
        thresholds[testEar][freq] = gainToRelativeDb(sliderToGain(EXT_VOLUME));
        hearingRange[testEar].max = freq;
        extIdx++;
        if (extIdx >= HIGH_EXT.length) { checkLowExtension(); }
        else { showCurrentStep(); }
      } else {
        thresholds[testEar][freq] = 100;
        bisectLo = hearingRange[testEar].max;
        bisectHi = freq;
        bisectCount = 0;
        if (bisectHi - bisectLo < 200) { checkLowExtension(); }
        else { testPhase = 'high-bisect'; showCurrentStep(); }
      }
    }

    function recordHighBisect(heard) {
      var mid = roundFreq((bisectLo + bisectHi) / 2);
      if (heard) {
        bisectLo = mid;
        hearingRange[testEar].max = mid;
        thresholds[testEar][mid] = gainToRelativeDb(sliderToGain(EXT_VOLUME));
      } else {
        bisectHi = mid;
        thresholds[testEar][mid] = 100;
      }
      bisectCount++;
      if (bisectCount >= 3 || bisectHi - bisectLo < 200) { hearingRange[testEar].max = bisectLo; checkLowExtension(); }
      else { showCurrentStep(); }
    }

    function checkLowExtension() {
      if (thresholds[testEar][125] < 80) { testPhase = 'low-ext'; extIdx = 0; showCurrentStep(); }
      else { finishEar(); }
    }

    function recordLowExt(heard) {
      var freq = LOW_EXT[extIdx];
      if (heard) {
        thresholds[testEar][freq] = gainToRelativeDb(sliderToGain(EXT_VOLUME));
        hearingRange[testEar].min = freq;
        extIdx++;
        if (extIdx >= LOW_EXT.length) { finishEar(); }
        else { showCurrentStep(); }
      } else {
        thresholds[testEar][freq] = 100;
        bisectHi = hearingRange[testEar].min;
        bisectLo = freq;
        bisectCount = 0;
        if (bisectHi - bisectLo < 10) { finishEar(); }
        else { testPhase = 'low-bisect'; showCurrentStep(); }
      }
    }

    function recordLowBisect(heard) {
      var mid = roundFreq((bisectLo + bisectHi) / 2);
      if (heard) {
        bisectHi = mid;
        hearingRange[testEar].min = mid;
        thresholds[testEar][mid] = gainToRelativeDb(sliderToGain(EXT_VOLUME));
      } else {
        bisectLo = mid;
        thresholds[testEar][mid] = 100;
      }
      bisectCount++;
      if (bisectCount >= 3 || bisectHi - bisectLo < 10) { hearingRange[testEar].min = bisectHi; finishEar(); }
      else { showCurrentStep(); }
    }

    function finishEar() {
      if (testEar === 'right') { $('ear-transition').classList.add('active'); }
      else { showResults(); }
    }

    $('btn-hear').addEventListener('click', function() { recordResponse(true); });
    $('btn-no-hear').addEventListener('click', function() { recordResponse(false); });
    $('btn-start-left').addEventListener('click', function() {
      testEar = 'left'; testPhase = 'standard'; freqIndex = 0; showCurrentStep();
    });

    $('mini-audiogram-wrap').addEventListener('click', function() { updateOverlayAudiogram(); $('audiogram-overlay').classList.add('active'); });
    $('overlay-close').addEventListener('click', function() { $('audiogram-overlay').classList.remove('active'); });
    $('audiogram-overlay').addEventListener('click', function(e) { if (e.target === this) this.classList.remove('active'); });

    /* ============ SCREEN 4: RESULTS ============ */
    function showResults() {
      showScreen('screen-results');
      $('results-subtitle').textContent = 'Audiogram of ' + userName;
      var ptaR = computePTA(thresholds.right), ptaL = computePTA(thresholds.left);
      var classR = classify(ptaR), classL = classify(ptaL);
      $('pta-right').textContent = ptaR; $('pta-left').textContent = ptaL;
      $('class-right').textContent = classR; $('class-left').textContent = classL;
      $('range-right').textContent = formatFreq(hearingRange.right.min) + ' — ' + formatFreq(hearingRange.right.max);
      $('range-left').textContent = formatFreq(hearingRange.left.min) + ' — ' + formatFreq(hearingRange.left.max);
      buildFullAudiogram();
      buildInterpretation(ptaR, ptaL, classR, classL);
      updateAshaMarker(ptaR, ptaL);
      trackAction('Hearing Test: completed', 'PTA R: ' + ptaR + ' dB (' + classR + ') | PTA L: ' + ptaL + ' dB (' + classL + ') | Range R: ' + hearingRange.right.min + '-' + hearingRange.right.max + ' Hz | Range L: ' + hearingRange.left.min + '-' + hearingRange.left.max + ' Hz');
    }

    function buildInterpretation(ptaR, ptaL, classR, classL) {
      var text = '', avgPta = Math.round((ptaR + ptaL) / 2);
      if (avgPta <= 15) text += 'Your results suggest hearing within normal parameters. You can probably perceive all human speech sounds in the audiogram\'s "speech banana". ';
      else if (avgPta <= 25) text += 'Your results suggest slight hearing loss. You may have some difficulty hearing soft sounds or whispers, especially in noisy environments. ';
      else if (avgPta <= 40) text += 'Your results suggest mild hearing loss. You may have difficulty following group conversations or with background noise. Some sounds in the "speech banana" may already be escaping you. ';
      else if (avgPta <= 55) text += 'Your results suggest moderate hearing loss. You probably frequently have difficulty in normal conversations and miss significant parts of speech. ';
      else text += 'Your results suggest significant hearing loss. Verbal communication without amplification is probably very difficult. ';

      var avgMax = Math.round((hearingRange.right.max + hearingRange.left.max) / 2);
      if (avgMax >= 16000) text += 'Your high-frequency range is excellent — you can hear sounds that most adults can no longer perceive. ';
      else if (avgMax < 8000) text += 'Your high-frequency range appears reduced, which may make it harder to distinguish certain sounds like "s", "f" or "z". ';

      if (Math.abs(ptaR - ptaL) >= 15) text += 'Note: There is an asymmetric difference between both ears, which may warrant investigation. ';
      if (userAge && userAge >= 55) text += 'Presbycusis (age-related hearing loss) is natural and becomes more pronounced over time. ';
      text += 'Remember that these values are relative to your device\'s calibration and are for educational purposes only.';
      $('interpretation-text').textContent = text;
    }

    function updateAshaMarker(ptaR, ptaL) {
      var avg = Math.round((ptaR + ptaL) / 2);
      $('asha-marker').style.left = Math.min(100, Math.max(0, avg)) + '%';
      $('asha-marker').setAttribute('data-label', avg + ' dB');
    }

    /* ============ PDF (dynamic labels + blue thicker) ============ */
    function createPdfAudiogram() {
      var dynFreqs = getActiveFreqs();
      var c = document.createElement('canvas'); c.width = 900; c.height = 500;
      c.style.position = 'fixed'; c.style.left = '-9999px';
      document.body.appendChild(c);
      var ctx = c.getContext('2d');
      ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, 900, 500);

      var rD = [], lD = [];
      for (var i = 0; i < dynFreqs.length; i++) {
        var f = dynFreqs[i];
        rD.push(typeof thresholds.right[f] === 'number' ? thresholds.right[f] : null);
        lD.push(typeof thresholds.left[f] === 'number' ? thresholds.left[f] : null);
      }
      var idx500 = findFreqIdx(dynFreqs, 500);
      var idx6000 = findFreqIdx(dynFreqs, 6000);
      var chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dynFreqs.map(freqToLabel),
          datasets: [
            { label: 'Right', data: rD, borderColor: '#dc2626', backgroundColor: '#dc2626', pointStyle: 'circle', pointRadius: 6, pointBorderWidth: 2, borderWidth: 2, tension: 0, spanGaps: true },
            { label: 'Left', data: lD, borderColor: '#2563eb', backgroundColor: '#2563eb', pointStyle: 'crossRot', pointRadius: 9, pointBorderWidth: 3, borderWidth: 3, tension: 0, spanGaps: true }
          ]
        },
        options: {
          responsive: false, animation: false,
          plugins: {
            legend: { labels: { color: '#000', usePointStyle: true } },
            annotation: { annotations: {
              speechBanana: { type: 'box', xMin: idx500, xMax: idx6000, yMin: 20, yMax: 50, backgroundColor: 'rgba(180,160,60,0.1)', borderColor: 'rgba(180,160,60,0.4)', borderWidth: 1, label: { display: true, content: 'Speech Banana', color: '#888', font: { size: 10 }, position: 'start' } },
              normalLine: { type: 'line', yMin: 20, yMax: 20, borderColor: 'rgba(34,160,94,0.5)', borderWidth: 1, borderDash: [4, 4], label: { display: true, content: 'Normal limit (20 dB)', color: '#888', font: { size: 9 }, position: 'end' } }
            }}
          },
          scales: {
            x: { title: { display: true, text: 'Frequency (Hz)', color: '#333', font: { size: 11 } }, ticks: { color: '#333' }, grid: { color: 'rgba(0,0,0,0.1)' } },
            y: { title: { display: true, text: 'Hearing Level (dB)', color: '#333', font: { size: 11 } }, reverse: true, min: -10, max: 100, ticks: { color: '#333', stepSize: 10 }, grid: { color: 'rgba(0,0,0,0.1)' } }
          }
        }
      });
      var img = c.toDataURL('image/png');
      chart.destroy(); document.body.removeChild(c);
      return img;
    }

    $('btn-pdf').addEventListener('click', function() {
      var dynFreqs = getActiveFreqs();
      var jsPDF = window.jspdf.jsPDF;
      var doc = new jsPDF({ unit: 'mm', format: 'a4' });
      var pw = 210, m = 20, cw = pw - m * 2, y = m;

      doc.setFontSize(18); doc.setFont(undefined, 'bold'); doc.setTextColor(0);
      doc.text('McMinsky - Educational Hearing Test', pw / 2, y, { align: 'center' }); y += 8;
      doc.setFontSize(9); doc.setFont(undefined, 'normal'); doc.setTextColor(120);
      doc.text('For educational purposes only - no clinical validity', pw / 2, y, { align: 'center' }); y += 10;

      doc.setTextColor(0); doc.setFontSize(10);
      doc.text('Name: ' + userName, m, y);
      doc.text('Age: ' + (userAge || 'N/A'), m + 80, y);
      doc.text('Date: ' + new Date().toLocaleDateString('en-GB'), m + 130, y); y += 8;

      try {
        var imgData = createPdfAudiogram();
        doc.addImage(imgData, 'PNG', m, y, cw, cw * 0.55); y += cw * 0.55 + 6;
      } catch(e) { doc.text('(Audiogram not available)', m, y); y += 6; }

      doc.setFontSize(9); doc.setFont(undefined, 'bold'); doc.setTextColor(0);
      doc.text('Thresholds by Frequency (relative dB)', m, y); y += 5;
      doc.setFont(undefined, 'normal'); doc.setFontSize(8);
      var colW = cw / (dynFreqs.length + 1);
      doc.setFillColor(240, 240, 240); doc.rect(m, y - 3, cw, 5, 'F');
      doc.setTextColor(0); doc.text('Hz', m + 2, y);
      for (var i = 0; i < dynFreqs.length; i++) doc.text(freqToLabel(dynFreqs[i]), m + colW * (i + 1), y);
      y += 5;
      doc.setTextColor(200, 40, 40); doc.text('R.', m + 2, y);
      for (var j = 0; j < dynFreqs.length; j++) { var v = thresholds.right[dynFreqs[j]]; doc.text(typeof v === 'number' ? v + '' : '-', m + colW * (j + 1), y); } y += 4;
      doc.setTextColor(40, 80, 200); doc.text('L.', m + 2, y);
      for (var l = 0; l < dynFreqs.length; l++) { var vl = thresholds.left[dynFreqs[l]]; doc.text(typeof vl === 'number' ? vl + '' : '-', m + colW * (l + 1), y); } y += 8;

      doc.setTextColor(0); doc.setFontSize(10); doc.setFont(undefined, 'bold');
      var ptaR = computePTA(thresholds.right), ptaL = computePTA(thresholds.left);
      doc.text('PTA Right: ' + ptaR + ' dB (' + classify(ptaR) + ')', m, y); y += 5;
      doc.text('PTA Left: ' + ptaL + ' dB (' + classify(ptaL) + ')', m, y); y += 5;
      doc.setFont(undefined, 'normal');
      doc.text('Range R.: ' + formatFreq(hearingRange.right.min) + ' - ' + formatFreq(hearingRange.right.max), m, y); y += 5;
      doc.text('Range L.: ' + formatFreq(hearingRange.left.min) + ' - ' + formatFreq(hearingRange.left.max), m, y); y += 10;

      doc.setFontSize(7); doc.setTextColor(100);
      var disc = 'NOTICE: This test is for educational purposes only and does not replace a professional audiological assessment. The values shown are relative to the device calibration level and do not correspond to clinically calibrated dB HL. If you suspect hearing loss, please consult an ENT specialist or audiologist.';
      var sd = doc.splitTextToSize(disc, cw); doc.text(sd, m, y);

      doc.setFontSize(8); doc.setTextColor(140);
      doc.text('mcminsky.pt - Educational Tests For The Whole Family', pw / 2, 285, { align: 'center' });

      doc.save('hearing-test-' + userName.toLowerCase().replace(/\s+/g, '-') + '.pdf');
      trackAction('Hearing Test: PDF');
    });

    /* ============ RESTART ============ */
    $('btn-restart').addEventListener('click', function() {
      thresholds = { right: {}, left: {} };
      hearingRange = { right: { max: 8000, min: 125 }, left: { max: 8000, min: 125 } };
      testEar = 'right'; testPhase = 'standard'; freqIndex = 0;
      if (miniChart) { miniChart.destroy(); miniChart = null; }
      if (overlayChart) { overlayChart.destroy(); overlayChart = null; }
      if (fullChart) { fullChart.destroy(); fullChart = null; }
      showScreen('screen-intro');
    });

    /* ============ INIT ============ */
    buildAnimalChart();
    buildCarousel();
  })();
  </script>
</body>
</html>
