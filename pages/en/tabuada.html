<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Adaptive multiplication table drill based on neuroscience. Focus on your weak spots and master multiplication.">
  <meta name="short-description" content="Adaptive multiplication drill â€” focus on your weak spots.">
  <meta name="icon" content="Ã—">
  <title>Multiplication Table Drill | McMinsky</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/T27BCpJj/logo-without-text.png">
  <link rel="stylesheet" href="../../css/styles.css">
  <style>
    .tabuada-container {
      max-width: 700px;
      margin: 0 auto;
      padding: calc(var(--header-height) + var(--space-lg)) var(--space-sm) var(--space-xl);
    }
    .screen { display: none; }
    .screen.active { display: block; }

    /* Setup */
    .setup-header { text-align: center; margin-bottom: var(--space-lg); }
    .setup-header h1 {
      font-family: var(--font-display);
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      color: var(--white);
      margin-bottom: var(--space-sm);
    }
    .setup-header h1 strong { color: var(--gold); }
    .setup-intro {
      color: var(--white-dim);
      font-size: 0.95rem;
      line-height: 1.6;
      max-width: 540px;
      margin: 0 auto var(--space-md);
      text-align: center;
    }
    .data-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.3);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--gold);
    }
    .data-badge svg { width: 14px; height: 14px; }

    /* Reference table toggle */
    .ref-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: none;
      border: 1px solid rgba(255,255,255,0.15);
      color: var(--white-dim);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      margin: var(--space-md) auto;
      transition: all 0.3s;
    }
    .ref-toggle:hover { border-color: var(--gold); color: var(--gold); }
    .ref-toggle svg { width: 16px; height: 16px; transition: transform 0.3s; }
    .ref-toggle.open svg { transform: rotate(180deg); }
    .ref-table-wrap {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
      text-align: center;
    }
    .ref-table-wrap.open { max-height: 500px; }
    .ref-table-wrap img {
      max-width: 100%;
      border-radius: 8px;
      margin-bottom: var(--space-md);
    }

    /* Number chips */
    .chips-label {
      color: var(--white-dim);
      font-size: 0.85rem;
      text-align: center;
      margin-bottom: var(--space-xs);
    }
    .chips-wrap {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: var(--space-lg);
    }
    .chip {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.2);
      background: var(--black-lighter);
      color: var(--white);
      font-family: var(--font-display);
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-user-select: none;
      user-select: none;
    }
    .chip.active {
      border-color: var(--gold);
      background: rgba(212,175,55,0.15);
      color: var(--gold);
      transform: scale(1.08);
    }
    .chip:hover { border-color: rgba(212,175,55,0.5); }

    /* Previous stats */
    .prev-stats {
      display: flex;
      justify-content: center;
      gap: var(--space-lg);
      margin-bottom: var(--space-lg);
    }
    .prev-stat { text-align: center; }
    .prev-stat-value {
      font-family: var(--font-display);
      font-size: 1.3rem;
      color: var(--gold);
    }
    .prev-stat-label {
      font-size: 0.75rem;
      color: var(--white-dim);
      margin-top: 2px;
    }

    /* Buttons */
    .start-btn {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 0 auto var(--space-sm);
      padding: 14px;
      background: var(--gold);
      color: var(--black);
      border: none;
      border-radius: 8px;
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .start-btn:hover { background: var(--gold-light); transform: translateY(-2px); }
    .start-btn:active { transform: scale(0.98); }
    .reset-link {
      display: block;
      text-align: center;
      color: var(--white-dim);
      font-size: 0.8rem;
      cursor: pointer;
      background: none;
      border: none;
      text-decoration: underline;
      margin: var(--space-sm) auto 0;
    }
    .reset-link:hover { color: var(--gold); }

    /* Game */
    .game-box {
      background: var(--black-lighter);
      border: 2px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: var(--space-lg) var(--space-md);
      transition: all 0.3s;
    }
    .game-box.correct-flash {
      border-color: #2ecc71;
      box-shadow: 0 0 30px rgba(46,204,113,0.2);
      transform: scale(1.02);
    }
    .game-box.wrong-shake {
      border-color: #e74c3c;
      box-shadow: 0 0 30px rgba(231,76,60,0.2);
      animation: shake 0.5s;
    }
    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 14px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      margin-bottom: var(--space-lg);
      font-size: 0.85rem;
    }
    .stat-item {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--white-dim);
    }
    .stat-item .val { color: var(--gold); font-weight: 600; }
    .streak-fire { display: none; font-size: 0.9rem; }
    .streak-fire.visible { display: inline; }
    .question-area { text-align: center; margin-bottom: var(--space-md); }
    .question-text {
      font-family: var(--font-display);
      font-size: clamp(2.5rem, 10vw, 4rem);
      color: var(--white);
      margin-bottom: var(--space-xs);
      line-height: 1.2;
    }
    .timer-display {
      font-size: 1rem;
      color: var(--white-dim);
      font-variant-numeric: tabular-nums;
      transition: color 0.3s;
    }
    .timer-display.slow { color: #e74c3c; animation: pulse 1s infinite; }
    .input-area {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: var(--space-sm);
    }
    .answer-input {
      width: 120px;
      height: 60px;
      text-align: center;
      font-family: var(--font-display);
      font-size: 2rem;
      background: var(--black-lighter);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: var(--white);
      outline: none;
      transition: border-color 0.3s;
    }
    .answer-input:focus { border-color: var(--gold); }
    .submit-btn {
      height: 60px;
      padding: 0 24px;
      background: var(--gold);
      color: var(--black);
      border: none;
      border-radius: 8px;
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .submit-btn:hover { background: var(--gold-light); }
    .submit-btn:active { transform: scale(0.95); }
    .correct-answer-display {
      font-family: var(--font-display);
      font-size: 1.1rem;
      color: #e74c3c;
      text-align: center;
      min-height: 1.6em;
      margin-bottom: var(--space-sm);
    }
    .game-controls {
      display: flex;
      justify-content: center;
      gap: 12px;
    }
    .ctrl-btn {
      padding: 8px 20px;
      background: none;
      border: 1px solid rgba(255,255,255,0.15);
      color: var(--white-dim);
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .ctrl-btn:hover { border-color: var(--gold); color: var(--gold); }

    /* Results */
    .results-header { text-align: center; margin-bottom: var(--space-lg); }
    .results-header h2 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      color: var(--white);
      margin-bottom: var(--space-xs);
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: var(--space-md);
    }
    .summary-card {
      background: var(--black-lighter);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 14px;
      text-align: center;
    }
    .summary-value {
      font-family: var(--font-display);
      font-size: 1.4rem;
      color: var(--gold);
    }
    .summary-label {
      font-size: 0.75rem;
      color: var(--white-dim);
      margin-top: 4px;
    }
    .best-streak-text {
      text-align: center;
      color: var(--white-dim);
      font-size: 0.9rem;
      margin-bottom: var(--space-lg);
    }
    .best-streak-text strong { color: var(--gold); }

    /* Heatmap */
    .heatmap-section { margin-bottom: var(--space-lg); }
    .section-title {
      font-family: var(--font-display);
      font-size: 1rem;
      color: var(--white);
      margin-bottom: var(--space-sm);
      text-align: center;
    }
    .heatmap-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 4px;
    }
    .heatmap {
      display: grid;
      grid-template-columns: 32px repeat(8, 1fr);
      gap: 2px;
      min-width: 310px;
    }
    .hm-header {
      font-size: 0.7rem;
      color: var(--white-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      min-height: 32px;
    }
    .hm-cell {
      aspect-ratio: 1;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      color: rgba(255,255,255,0.8);
      cursor: default;
      min-width: 32px;
      line-height: 1.2;
    }
    .hm-cell .hm-acc {
      font-size: 0.5rem;
      opacity: 0.7;
    }
    .heatmap-legend {
      display: flex;
      justify-content: center;
      gap: 14px;
      margin-top: var(--space-sm);
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      color: var(--white-dim);
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    /* Weak pairs */
    .weak-section { margin-bottom: var(--space-lg); }
    .weak-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .weak-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--black-lighter);
      border: 1px solid rgba(231,76,60,0.3);
      border-radius: 8px;
      padding: 12px 16px;
    }
    .weak-pair {
      font-family: var(--font-display);
      font-size: 1.1rem;
      color: var(--white);
    }
    .weak-info {
      font-size: 0.8rem;
      color: var(--white-dim);
    }

    /* Action buttons */
    .results-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .action-btn {
      padding: 12px 28px;
      border-radius: 8px;
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
    }
    .action-btn.primary {
      background: var(--gold);
      color: var(--black);
    }
    .action-btn.primary:hover { background: var(--gold-light); transform: translateY(-2px); }
    .action-btn.secondary {
      background: none;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--white);
    }
    .action-btn.secondary:hover { border-color: var(--gold); color: var(--gold); }

    /* Streak milestone */
    .streak-milestone {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: var(--font-display);
      font-size: 3rem;
      color: var(--gold);
      pointer-events: none;
      z-index: 20;
      opacity: 0;
      animation: streakPop 1s ease-out forwards;
      text-shadow: 0 0 30px rgba(201,169,98,0.5);
    }

    /* Animations */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-8px); }
      40%, 80% { transform: translateX(8px); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes streakPop {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
      100% { opacity: 0; transform: translate(-50%, -70%) scale(1); }
    }
  </style>
</head>
<body class="loading">
  <div class="loader">
    <img src="https://i.postimg.cc/T27BCpJj/logo-without-text.png" alt="McMinsky" class="loader-logo">
    <span class="loader-text">McMinsky</span>
    <div class="loader-bar"></div>
  </div>

  <header class="header">
    <div class="header-inner">
      <a href="/en/" class="logo">
        <img src="https://i.postimg.cc/T27BCpJj/logo-without-text.png" alt="McMinsky Logo">
        <span class="logo-text">McMinsky</span>
      </a>
      <button class="nav-toggle" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
      <nav class="nav">
        <ul class="nav-list">
          <li class="nav-item"><a href="/en/" class="nav-link">Home</a></li>
          <li class="nav-item"><a href="/en/#programs" class="nav-link">Programs</a></li>
          <li class="nav-item"><a href="/en/#tools" class="nav-link">Tools</a></li>
          <li class="nav-item"><a href="/en/#contact" class="nav-link">Contact</a></li>
        </ul>
        <div class="lang-switch">
          <button class="lang-btn" data-lang="pt">PT</button>
          <button class="lang-btn active" data-lang="en">EN</button>
        </div>
      </nav>
    </div>
  </header>

  <div class="tabuada-container">
    <!-- SETUP SCREEN -->
    <div class="screen active" id="setup-screen">
      <div class="setup-header">
        <h1>Multiplication <strong>Table</strong> Drill</h1>
        <p class="setup-intro">This drill automatically adapts to your weak spots. The algorithm uses neuroscience principles â€” spaced repetition, immediate reinforcement, and adaptive focus â€” to accelerate your learning.</p>
        <span class="data-badge">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
          Data stored only on your device
        </span>
      </div>

      <button class="ref-toggle" id="ref-toggle-setup">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        Reference table
      </button>
      <div class="ref-table-wrap" id="ref-table-setup">
        <img src="https://i.postimg.cc/bYBLCfrv/multiplication-table-1.png" alt="Multiplication table" loading="lazy">
      </div>

      <p class="chips-label">Select numbers to practice (minimum 2):</p>
      <div class="chips-wrap" id="chips-wrap"></div>

      <div class="prev-stats" id="prev-stats">
        <div class="prev-stat">
          <div class="prev-stat-value" id="prev-mastered">0/36</div>
          <div class="prev-stat-label">Mastered</div>
        </div>
        <div class="prev-stat">
          <div class="prev-stat-value" id="prev-accuracy">0%</div>
          <div class="prev-stat-label">Accuracy</div>
        </div>
        <div class="prev-stat">
          <div class="prev-stat-value" id="prev-streak">0</div>
          <div class="prev-stat-label">Best streak</div>
        </div>
      </div>

      <button class="start-btn" id="start-btn">Start</button>
      <button class="reset-link" id="reset-link">Reset data</button>
    </div>

    <!-- GAME SCREEN -->
    <div class="screen" id="game-screen">
      <div class="game-box" id="game-box">
        <div class="stats-bar">
          <div class="stat-item"><span class="streak-fire" id="streak-fire">ðŸ”¥</span> Streak: <span class="val" id="streak-val">0</span></div>
          <div class="stat-item">Accuracy: <span class="val" id="accuracy-val">0%</span></div>
          <div class="stat-item"># <span class="val" id="question-num">0</span></div>
        </div>
        <div class="question-area">
          <div class="question-text" id="question-text">0 Ã— 0 = ?</div>
          <div class="timer-display" id="timer-display">0.0s</div>
        </div>
        <div class="input-area">
          <input class="answer-input" id="answer-input" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" autofocus>
          <button class="submit-btn" id="submit-btn">OK</button>
        </div>
        <div class="correct-answer-display" id="correct-answer-display"></div>
        <div class="game-controls">
          <button class="ctrl-btn" id="pause-btn">Pause</button>
          <button class="ctrl-btn" id="ref-toggle-game">See table</button>
        </div>
        <div class="ref-table-wrap" id="ref-table-game">
          <img src="https://i.postimg.cc/bYBLCfrv/multiplication-table-1.png" alt="Multiplication table" loading="lazy" style="margin-top:var(--space-sm)">
        </div>
      </div>
    </div>

    <!-- RESULTS SCREEN -->
    <div class="screen" id="results-screen">
      <div class="results-header">
        <h2>Results</h2>
      </div>
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-value" id="res-total">0</div>
          <div class="summary-label">Questions</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="res-correct">0</div>
          <div class="summary-label">Correct</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="res-accuracy">0%</div>
          <div class="summary-label">Accuracy</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="res-time">0s</div>
          <div class="summary-label">Avg time</div>
        </div>
      </div>
      <p class="best-streak-text">All-time best streak: <strong id="res-streak">0</strong></p>

      <div class="heatmap-section">
        <div class="section-title">Performance Map</div>
        <div class="heatmap-wrap">
          <div class="heatmap" id="heatmap"></div>
        </div>
        <div class="heatmap-legend">
          <div class="legend-item"><span class="legend-color" style="background:#2ecc71"></span> Mastered</div>
          <div class="legend-item"><span class="legend-color" style="background:#c9a962"></span> Familiar</div>
          <div class="legend-item"><span class="legend-color" style="background:#e74c3c"></span> Struggling</div>
          <div class="legend-item"><span class="legend-color" style="background:#333"></span> Not attempted</div>
        </div>
      </div>

      <div class="weak-section" id="weak-section">
        <div class="section-title">Focus on these:</div>
        <div class="weak-list" id="weak-list"></div>
      </div>

      <div class="results-actions">
        <button class="action-btn primary" id="continue-btn">Continue</button>
        <button class="action-btn secondary" id="restart-btn">Restart</button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-bottom">
      <div class="footer-legal">
        <a href="../../legal/en/terms.html">Terms & Conditions</a>
        <a href="../../legal/en/privacy.html">Privacy Policy</a>
        <a href="https://www.livroreclamacoes.pt/inicio/reclamacao?nipc=517747120" target="_blank">Complaints Book</a>
      </div>
      <p class="footer-copyright">&copy; <span class="current-year">2025</span> McMinsky. All rights reserved.</p>
    </div>
  </footer>

  <script src="../../js/main.js"></script>
  <script>
    (function() {
      var STORAGE_KEY = 'mcminsky_tabuada';
      var MAX_TIMES = 10;
      var TOTAL_PAIRS = 36;

      /* --- DOM refs --- */
      var $ = function(id) { return document.getElementById(id); };
      var setupScreen = $('setup-screen');
      var gameScreen = $('game-screen');
      var resultsScreen = $('results-screen');
      var chipsWrap = $('chips-wrap');
      var startBtn = $('start-btn');
      var resetLink = $('reset-link');
      var gameBox = $('game-box');
      var questionText = $('question-text');
      var timerDisplay = $('timer-display');
      var answerInput = $('answer-input');
      var submitBtn = $('submit-btn');
      var correctAnswerDisplay = $('correct-answer-display');
      var streakVal = $('streak-val');
      var accuracyVal = $('accuracy-val');
      var questionNum = $('question-num');
      var streakFire = $('streak-fire');
      var pauseBtn = $('pause-btn');
      var continueBtn = $('continue-btn');
      var restartBtn = $('restart-btn');

      /* --- State --- */
      var data = loadData();
      var activeNums = [2,3,4,5,6,7,8,9];
      var currentA = 0, currentB = 0;
      var lastKey = '';
      var streak = 0;
      var sessionTotal = 0, sessionCorrect = 0, sessionTimes = [];
      var timerStart = 0, timerInterval = null;
      var locked = false;
      var gameActive = false;

      /* --- Data persistence --- */
      function loadData() {
        try {
          var s = localStorage.getItem(STORAGE_KEY);
          if (s) return JSON.parse(s);
        } catch(e) {}
        return { pairs: {}, bestStreak: 0, totalAttempts: 0, totalCorrect: 0 };
      }

      function saveData() {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
      }

      /* --- Pair helpers --- */
      function nk(a, b) { return Math.min(a,b) + 'x' + Math.max(a,b); }

      function getRec(key) {
        if (!data.pairs[key]) {
          data.pairs[key] = { attempts: 0, correct: 0, times: [], lastSeen: 0, lastCorrect: true };
        }
        return data.pairs[key];
      }

      function classify(rec) {
        if (rec.attempts === 0) return 'new';
        var acc = rec.correct / rec.attempts;
        var avg = avgTime(rec);
        if (acc > 0.9 && avg < 3 && rec.attempts >= 5) return 'mastered';
        if (acc < 0.7 || avg > 6) return 'struggling';
        return 'familiar';
      }

      function avgTime(rec) {
        if (!rec.times.length) return 999;
        var sum = 0;
        for (var i = 0; i < rec.times.length; i++) sum += rec.times[i];
        return sum / rec.times.length;
      }

      /* --- Active pairs from selected numbers --- */
      function getActivePairs() {
        var pairs = [];
        for (var i = 0; i < activeNums.length; i++) {
          for (var j = i; j < activeNums.length; j++) {
            pairs.push(nk(activeNums[i], activeNums[j]));
          }
        }
        return pairs;
      }

      /* --- Adaptive selection --- */
      function getWeight(key) {
        var rec = getRec(key);
        if (rec.attempts === 0) return 5;
        if (!rec.lastCorrect) return 4;
        var acc = rec.correct / rec.attempts;
        var avg = avgTime(rec);
        if (acc < 0.7) return 3;
        if (avg > 5) return 2;
        if (acc > 0.9 && avg < 3 && rec.attempts >= 5) return 1;
        return 2;
      }

      function selectQuestion() {
        var pairs = getActivePairs();
        if (!pairs.length) return null;
        var weights = [];
        var totalW = 0;
        for (var i = 0; i < pairs.length; i++) {
          var w = (pairs[i] === lastKey && pairs.length > 1) ? 0 : getWeight(pairs[i]);
          weights.push(w);
          totalW += w;
        }
        if (totalW === 0) { totalW = pairs.length; for (var i = 0; i < pairs.length; i++) weights[i] = 1; }
        var rand = Math.random() * totalW;
        var cum = 0;
        for (var i = 0; i < pairs.length; i++) {
          cum += weights[i];
          if (rand <= cum) return pairs[i];
        }
        return pairs[pairs.length - 1];
      }

      /* --- Screens --- */
      function showScreen(name) {
        setupScreen.classList.remove('active');
        gameScreen.classList.remove('active');
        resultsScreen.classList.remove('active');
        if (name === 'setup') setupScreen.classList.add('active');
        else if (name === 'game') gameScreen.classList.add('active');
        else if (name === 'results') resultsScreen.classList.add('active');
      }

      /* --- Setup stats --- */
      function updateSetupStats() {
        var mastered = 0;
        for (var i = 2; i <= 9; i++) {
          for (var j = i; j <= 9; j++) {
            if (classify(getRec(nk(i,j))) === 'mastered') mastered++;
          }
        }
        var acc = data.totalAttempts > 0 ? Math.round(data.totalCorrect / data.totalAttempts * 100) : 0;
        $('prev-mastered').textContent = mastered + '/' + TOTAL_PAIRS;
        $('prev-accuracy').textContent = acc + '%';
        $('prev-streak').textContent = data.bestStreak;
      }

      /* --- Timer --- */
      function startTimer() {
        timerStart = Date.now();
        timerDisplay.textContent = '0.0s';
        timerDisplay.classList.remove('slow');
        timerInterval = setInterval(function() {
          var elapsed = (Date.now() - timerStart) / 1000;
          timerDisplay.textContent = elapsed.toFixed(1) + 's';
          if (elapsed > 5) timerDisplay.classList.add('slow');
        }, 100);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        return (Date.now() - timerStart) / 1000;
      }

      /* --- Game flow --- */
      function startGame() {
        showScreen('game');
        streak = 0;
        sessionTotal = 0;
        sessionCorrect = 0;
        sessionTimes = [];
        gameActive = true;
        locked = false;
        updateStatsBar();
        nextQuestion();
      }

      function nextQuestion() {
        var key = selectQuestion();
        if (!key) return;
        var parts = key.split('x');
        var a = parseInt(parts[0]), b = parseInt(parts[1]);
        if (a !== b && Math.random() > 0.5) { var tmp = a; a = b; b = tmp; }
        currentA = a;
        currentB = b;
        lastKey = key;
        questionText.textContent = currentA + ' Ã— ' + currentB + ' = ?';
        correctAnswerDisplay.textContent = '';
        answerInput.value = '';
        answerInput.focus();
        startTimer();
      }

      function submitAnswer() {
        if (locked || !gameActive) return;
        var val = parseInt(answerInput.value);
        if (isNaN(val)) return;

        locked = true;
        var time = stopTimer();
        var answer = currentA * currentB;
        var correct = val === answer;
        var key = nk(currentA, currentB);
        var rec = getRec(key);

        rec.attempts++;
        data.totalAttempts++;
        sessionTotal++;

        if (correct) {
          rec.correct++;
          data.totalCorrect++;
          sessionCorrect++;
          streak++;
          if (streak > data.bestStreak) data.bestStreak = streak;
          rec.lastCorrect = true;
        } else {
          streak = 0;
          rec.lastCorrect = false;
        }

        rec.times.push(Math.round(time * 100) / 100);
        if (rec.times.length > MAX_TIMES) rec.times.shift();
        rec.lastSeen = Date.now();
        sessionTimes.push(time);
        saveData();
        updateStatsBar();

        if (correct) {
          gameBox.classList.add('correct-flash');
          if (streak > 0 && streak % 5 === 0) showStreakMilestone(streak);
          setTimeout(function() {
            gameBox.classList.remove('correct-flash');
            locked = false;
            nextQuestion();
          }, 600);
        } else {
          gameBox.classList.add('wrong-shake');
          correctAnswerDisplay.textContent = currentA + ' Ã— ' + currentB + ' = ' + answer;
          setTimeout(function() {
            gameBox.classList.remove('wrong-shake');
            correctAnswerDisplay.textContent = '';
            locked = false;
            nextQuestion();
          }, 1500);
        }
      }

      function updateStatsBar() {
        streakVal.textContent = streak;
        streakFire.classList.toggle('visible', streak >= 5);
        var acc = sessionTotal > 0 ? Math.round(sessionCorrect / sessionTotal * 100) : 0;
        accuracyVal.textContent = acc + '%';
        questionNum.textContent = sessionTotal;
      }

      function showStreakMilestone(n) {
        var el = document.createElement('div');
        el.className = 'streak-milestone';
        el.textContent = n + '!';
        document.body.appendChild(el);
        setTimeout(function() { el.remove(); }, 1000);
      }

      /* --- Results --- */
      function pauseGame() {
        gameActive = false;
        clearInterval(timerInterval);
        showResults();
      }

      function showResults() {
        showScreen('results');
        $('res-total').textContent = sessionTotal;
        $('res-correct').textContent = sessionCorrect;
        var acc = sessionTotal > 0 ? Math.round(sessionCorrect / sessionTotal * 100) : 0;
        $('res-accuracy').textContent = acc + '%';
        var avgT = sessionTimes.length > 0
          ? (sessionTimes.reduce(function(a,b){return a+b},0) / sessionTimes.length).toFixed(1)
          : '0';
        $('res-time').textContent = avgT + 's';
        $('res-streak').textContent = data.bestStreak;
        buildHeatmap();
        buildWeakPairs();
      }

      function buildHeatmap() {
        var container = $('heatmap');
        container.innerHTML = '';

        var corner = document.createElement('div');
        corner.className = 'hm-header';
        corner.textContent = 'Ã—';
        container.appendChild(corner);

        for (var c = 2; c <= 9; c++) {
          var h = document.createElement('div');
          h.className = 'hm-header';
          h.textContent = c;
          container.appendChild(h);
        }

        for (var r = 2; r <= 9; r++) {
          var rh = document.createElement('div');
          rh.className = 'hm-header';
          rh.textContent = r;
          container.appendChild(rh);

          for (var c = 2; c <= 9; c++) {
            var key = nk(r, c);
            var rec = getRec(key);
            var cls = classify(rec);
            var cell = document.createElement('div');
            cell.className = 'hm-cell';

            var color;
            if (cls === 'new') color = '#333';
            else if (cls === 'struggling') color = '#e74c3c';
            else if (cls === 'familiar') color = '#c9a962';
            else color = '#2ecc71';

            cell.style.background = color;
            var label = document.createElement('span');
            label.textContent = r + 'Ã—' + c;
            cell.appendChild(label);

            if (rec.attempts > 0) {
              var accSpan = document.createElement('span');
              accSpan.className = 'hm-acc';
              accSpan.textContent = Math.round(rec.correct / rec.attempts * 100) + '%';
              cell.appendChild(accSpan);
            }
            container.appendChild(cell);
          }
        }
      }

      function buildWeakPairs() {
        var weakList = $('weak-list');
        var weakSection = $('weak-section');
        weakList.innerHTML = '';

        var all = [];
        for (var key in data.pairs) {
          var rec = data.pairs[key];
          if (rec.attempts > 0) {
            var acc = rec.correct / rec.attempts;
            all.push({ key: key, acc: acc, avg: avgTime(rec), attempts: rec.attempts });
          }
        }

        all.sort(function(a, b) { return a.acc - b.acc || b.avg - a.avg; });
        var weak = all.slice(0, 3).filter(function(p) { return p.acc < 0.9; });

        if (weak.length === 0) {
          weakSection.style.display = 'none';
          return;
        }
        weakSection.style.display = '';

        for (var i = 0; i < weak.length; i++) {
          var p = weak[i];
          var parts = p.key.split('x');
          var item = document.createElement('div');
          item.className = 'weak-item';
          item.innerHTML = '<span class="weak-pair">' + parts[0] + ' Ã— ' + parts[1] +
            '</span><span class="weak-info">' + Math.round(p.acc * 100) + '% Â· ' +
            p.avg.toFixed(1) + 's Â· ' + p.attempts + ' attempts</span>';
          weakList.appendChild(item);
        }
      }

      /* --- Reset --- */
      function resetData() {
        if (!confirm('Are you sure you want to clear all training data?')) return;
        data = { pairs: {}, bestStreak: 0, totalAttempts: 0, totalCorrect: 0 };
        saveData();
        updateSetupStats();
      }

      /* --- Reference toggles --- */
      function setupRefToggle(btnId, wrapId) {
        var btn = $(btnId);
        var wrap = $(wrapId);
        btn.addEventListener('click', function() {
          var open = wrap.classList.toggle('open');
          btn.classList.toggle('open', open);
        });
      }

      /* --- Init --- */
      function init() {
        /* Build chips */
        for (var n = 2; n <= 9; n++) {
          var chip = document.createElement('div');
          chip.className = 'chip active';
          chip.dataset.num = n;
          chip.textContent = n;
          chip.addEventListener('click', (function(num) {
            return function() {
              if (this.classList.contains('active')) {
                var count = document.querySelectorAll('.chip.active').length;
                if (count <= 2) return;
                this.classList.remove('active');
                activeNums = activeNums.filter(function(x) { return x !== num; });
              } else {
                this.classList.add('active');
                activeNums.push(num);
                activeNums.sort(function(a,b){return a-b;});
              }
            };
          })(n));
          chipsWrap.appendChild(chip);
        }

        updateSetupStats();

        /* Reference table toggles */
        setupRefToggle('ref-toggle-setup', 'ref-table-setup');

        var refGameBtn = $('ref-toggle-game');
        var refGameWrap = $('ref-table-game');
        refGameBtn.addEventListener('click', function() {
          var open = refGameWrap.classList.toggle('open');
          refGameBtn.textContent = open ? 'Hide table' : 'See table';
        });

        /* Start */
        startBtn.addEventListener('click', startGame);

        /* Reset */
        resetLink.addEventListener('click', resetData);

        /* Submit */
        submitBtn.addEventListener('click', submitAnswer);

        /* Input */
        answerInput.addEventListener('input', function() {
          this.value = this.value.replace(/[^0-9]/g, '');
        });
        answerInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') submitAnswer();
          if (e.key === 'Escape') pauseGame();
        });

        /* Pause */
        pauseBtn.addEventListener('click', pauseGame);

        /* Results actions */
        continueBtn.addEventListener('click', function() {
          showScreen('game');
          gameActive = true;
          locked = false;
          nextQuestion();
        });
        restartBtn.addEventListener('click', function() {
          showScreen('setup');
          updateSetupStats();
        });
      }

      init();
    })();
  </script>
</body>
</html>
