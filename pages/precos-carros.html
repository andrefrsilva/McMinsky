<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Jogo de adivinha√ß√£o de pre√ßos de carros usados reais. Treina a tua intui√ß√£o financeira com an√∫ncios verdadeiros.">
  <meta name="short-description" content="Adivinha o pre√ßo de carros usados reais ‚Äî treina intui√ß√£o financeira.">
  <meta name="icon" content="‚Ç¨">
  <title>Quanto Custa? | McMinsky</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/T27BCpJj/logo-without-text.png">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .precos-container {
      max-width: 700px;
      margin: 0 auto;
      padding: calc(var(--header-height) + var(--space-lg)) var(--space-sm) var(--space-xl);
    }
    .screen { display: none; }
    .screen.active { display: block; }

    /* Setup */
    .setup-header { text-align: center; margin-bottom: var(--space-lg); }
    .setup-header h1 {
      font-family: var(--font-display);
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      color: var(--white);
      margin-bottom: var(--space-sm);
    }
    .setup-header h1 strong { color: var(--gold); }
    .setup-intro {
      color: var(--white-dim);
      font-size: 0.95rem;
      line-height: 1.6;
      max-width: 540px;
      margin: 0 auto var(--space-md);
      text-align: center;
    }
    .data-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.3);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--gold);
    }
    .data-badge svg { width: 14px; height: 14px; }

    /* Previous stats */
    .prev-stats {
      display: flex;
      justify-content: center;
      gap: var(--space-lg);
      margin-bottom: var(--space-lg);
    }
    .prev-stat { text-align: center; }
    .prev-stat-value {
      font-family: var(--font-display);
      font-size: 1.3rem;
      color: var(--gold);
    }
    .prev-stat-label {
      font-size: 0.75rem;
      color: var(--white-dim);
      margin-top: 2px;
    }

    /* Buttons */
    .start-btn {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 0 auto var(--space-sm);
      padding: 14px;
      background: var(--gold);
      color: var(--black);
      border: none;
      border-radius: 8px;
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .start-btn:hover { background: var(--gold-light); transform: translateY(-2px); }
    .start-btn:active { transform: scale(0.98); }
    .reset-link {
      display: block;
      text-align: center;
      color: var(--white-dim);
      font-size: 0.8rem;
      cursor: pointer;
      background: none;
      border: none;
      text-decoration: underline;
      margin: var(--space-sm) auto 0;
    }
    .reset-link:hover { color: var(--gold); }

    /* Game card */
    .game-card {
      background: var(--black-lighter);
      border: 2px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: var(--space-md);
      transition: border-color 0.4s, box-shadow 0.4s;
    }
    .game-card.correct-flash {
      border-color: #2ecc71;
      box-shadow: 0 0 30px rgba(46,204,113,0.2);
    }
    .game-card.wrong-flash {
      border-color: #e74c3c;
      box-shadow: 0 0 30px rgba(231,76,60,0.2);
    }

    /* Stats bar */
    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 14px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      margin-bottom: var(--space-md);
      font-size: 0.85rem;
    }
    .stat-item {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--white-dim);
    }
    .stat-item .val { color: var(--gold); font-weight: 600; }
    .streak-fire { display: none; font-size: 0.9rem; }
    .streak-fire.visible { display: inline; }

    /* Car image */
    .car-image-wrap {
      position: relative;
      width: 100%;
      max-height: 350px;
      overflow: hidden;
      border-radius: 8px;
      margin-bottom: var(--space-md);
      background: #111;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .car-image-wrap img {
      width: 100%;
      max-height: 350px;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .car-image-wrap img.loaded { opacity: 1; }
    .car-image-wrap::after {
      content: '';
      position: absolute;
      inset: 0;
      box-shadow: inset 0 -40px 30px -20px rgba(0,0,0,0.6);
      pointer-events: none;
      border-radius: 8px;
    }

    /* Timer */
    .timer-display {
      text-align: center;
      font-size: 1rem;
      color: var(--white-dim);
      font-variant-numeric: tabular-nums;
      margin-bottom: var(--space-md);
    }

    /* Loading spinner */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 250px;
      gap: var(--space-sm);
    }
    .gold-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(212,175,55,0.2);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .loading-text {
      color: var(--white-dim);
      font-size: 0.9rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Price reveal */
    .price-display {
      text-align: center;
      margin-bottom: var(--space-md);
    }
    .price-value {
      font-family: var(--font-display);
      font-size: clamp(1.8rem, 6vw, 2.5rem);
      color: var(--gold);
      opacity: 0;
      transform: scale(0.5);
      transition: opacity 0.4s, transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .price-value.revealed {
      opacity: 1;
      transform: scale(1);
    }

    /* Action buttons */
    .action-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: var(--space-sm);
      flex-wrap: wrap;
    }
    .btn-gold {
      padding: 12px 28px;
      background: var(--gold);
      color: var(--black);
      border: none;
      border-radius: 8px;
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 48px;
    }
    .btn-gold:hover { background: var(--gold-light); transform: translateY(-2px); }
    .btn-gold:active { transform: scale(0.98); }
    .btn-correct {
      padding: 12px 28px;
      background: none;
      border: 2px solid #2ecc71;
      color: #2ecc71;
      border-radius: 8px;
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 48px;
    }
    .btn-correct:hover { background: rgba(46,204,113,0.1); transform: translateY(-2px); }
    .btn-wrong {
      padding: 12px 28px;
      background: none;
      border: 2px solid #e74c3c;
      color: #e74c3c;
      border-radius: 8px;
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 48px;
    }
    .btn-wrong:hover { background: rgba(231,76,60,0.1); transform: translateY(-2px); }
    .btn-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      background: none;
      border: 1px solid rgba(255,255,255,0.15);
      color: var(--white-dim);
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s;
      min-height: 48px;
    }
    .btn-link:hover { border-color: var(--gold); color: var(--gold); }

    /* Error state */
    .error-state {
      text-align: center;
      padding: var(--space-lg) 0;
    }
    .error-state p {
      color: var(--white-dim);
      margin-bottom: var(--space-md);
    }

    /* Pause button */
    .pause-row {
      text-align: center;
      margin-top: var(--space-md);
    }
    .ctrl-btn {
      padding: 8px 20px;
      background: none;
      border: 1px solid rgba(255,255,255,0.15);
      color: var(--white-dim);
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .ctrl-btn:hover { border-color: var(--gold); color: var(--gold); }

    /* Results */
    .results-header { text-align: center; margin-bottom: var(--space-lg); }
    .results-header h2 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      color: var(--white);
      margin-bottom: var(--space-xs);
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: var(--space-md);
    }
    .summary-card {
      background: var(--black-lighter);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 14px;
      text-align: center;
    }
    .summary-value {
      font-family: var(--font-display);
      font-size: 1.4rem;
      color: var(--gold);
    }
    .summary-label {
      font-size: 0.75rem;
      color: var(--white-dim);
      margin-top: 4px;
    }
    .best-streak-text {
      text-align: center;
      color: var(--white-dim);
      font-size: 0.9rem;
      margin-bottom: var(--space-lg);
    }
    .best-streak-text strong { color: var(--gold); }
    .results-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .action-btn {
      padding: 12px 28px;
      border-radius: 8px;
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
    }
    .action-btn.primary {
      background: var(--gold);
      color: var(--black);
    }
    .action-btn.primary:hover { background: var(--gold-light); transform: translateY(-2px); }
    .action-btn.secondary {
      background: none;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--white);
    }
    .action-btn.secondary:hover { border-color: var(--gold); color: var(--gold); }

    /* Game sub-states visibility */
    .game-state { display: none; }
    .game-state.active { display: block; }
    .game-state.active.flex { display: flex; }
  </style>
</head>
<body class="loading">
  <div class="loader">
    <img src="https://i.postimg.cc/T27BCpJj/logo-without-text.png" alt="McMinsky" class="loader-logo">
    <span class="loader-text">McMinsky</span>
    <div class="loader-bar"></div>
  </div>

  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo">
        <img src="https://i.postimg.cc/T27BCpJj/logo-without-text.png" alt="McMinsky Logo">
        <span class="logo-text">McMinsky</span>
      </a>
      <button class="nav-toggle" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
      <nav class="nav">
        <ul class="nav-list">
          <li class="nav-item"><a href="/" class="nav-link">In√≠cio</a></li>
          <li class="nav-item"><a href="/#programs" class="nav-link">Programas</a></li>
          <li class="nav-item"><a href="/#tools" class="nav-link">Ferramentas</a></li>
          <li class="nav-item"><a href="/#contact" class="nav-link">Contacto</a></li>
        </ul>
        <div class="lang-switch">
          <button class="lang-btn active" data-lang="pt">PT</button>
          <button class="lang-btn" data-lang="en">EN</button>
        </div>
      </nav>
    </div>
  </header>

  <div class="precos-container">
    <!-- SETUP SCREEN -->
    <div class="screen active" id="setup-screen">
      <div class="setup-header">
        <h1>Quanto <strong>Custa</strong>?</h1>
        <p class="setup-intro">V√™s a foto de um carro usado real, anunciado no auto.sapo.pt. Sem marca, modelo ou ano ‚Äî apenas a imagem. Tenta adivinhar o pre√ßo, revela a resposta e diz-nos se acertaste. Treina a tua intui√ß√£o financeira!</p>
        <span class="data-badge">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
          Dados guardados apenas no teu dispositivo
        </span>
      </div>

      <div class="prev-stats" id="prev-stats">
        <div class="prev-stat">
          <div class="prev-stat-value" id="prev-rounds">0</div>
          <div class="prev-stat-label">Rondas</div>
        </div>
        <div class="prev-stat">
          <div class="prev-stat-value" id="prev-accuracy">0%</div>
          <div class="prev-stat-label">Precis√£o</div>
        </div>
        <div class="prev-stat">
          <div class="prev-stat-value" id="prev-streak">0</div>
          <div class="prev-stat-label">Melhor sequ√™ncia</div>
        </div>
      </div>

      <button class="start-btn" id="start-btn">Come√ßar</button>
      <button class="reset-link" id="reset-link">Limpar dados</button>
    </div>

    <!-- GAME SCREEN -->
    <div class="screen" id="game-screen">
      <div class="game-card" id="game-card">
        <div class="stats-bar">
          <div class="stat-item"><span class="streak-fire" id="streak-fire">üî•</span> Seq: <span class="val" id="streak-val">0</span></div>
          <div class="stat-item">Precis√£o: <span class="val" id="accuracy-val">0%</span></div>
          <div class="stat-item"># <span class="val" id="round-num">0</span></div>
        </div>

        <!-- Loading state -->
        <div class="game-state active flex loading-state" id="state-loading">
          <div class="gold-spinner"></div>
          <span class="loading-text">A carregar an√∫ncio...</span>
        </div>

        <!-- Guessing state -->
        <div class="game-state" id="state-guessing">
          <div class="car-image-wrap">
            <img id="car-image" alt="Carro usado">
          </div>
          <div class="timer-display" id="timer-display">0.0s</div>
          <div class="action-row">
            <button class="btn-gold" id="reveal-btn">Revelar Pre√ßo</button>
          </div>
        </div>

        <!-- Revealed state -->
        <div class="game-state" id="state-revealed">
          <div class="car-image-wrap">
            <img id="car-image-revealed" alt="Carro usado">
          </div>
          <div class="timer-display" id="timer-final"></div>
          <div class="price-display">
            <div class="price-value" id="price-value"></div>
          </div>
          <div class="action-row">
            <button class="btn-correct" id="btn-correct">Acertei</button>
            <button class="btn-wrong" id="btn-wrong">Errei</button>
          </div>
          <div class="action-row" style="margin-top: 4px;">
            <a class="btn-link" id="listing-link" href="#" target="_blank" rel="noopener">Ver an√∫ncio original ‚Üí</a>
          </div>
        </div>

        <!-- Next state -->
        <div class="game-state" id="state-next">
          <div class="car-image-wrap">
            <img id="car-image-next" alt="Carro usado">
          </div>
          <div class="price-display">
            <div class="price-value revealed" id="price-next"></div>
          </div>
          <div class="action-row" style="margin-top: 4px;">
            <a class="btn-link" id="listing-link-next" href="#" target="_blank" rel="noopener">Ver an√∫ncio original ‚Üí</a>
          </div>
          <div class="action-row">
            <button class="btn-gold" id="next-btn">Pr√≥ximo Carro ‚Üí</button>
          </div>
        </div>

        <!-- Error state -->
        <div class="game-state error-state" id="state-error">
          <p id="error-message">N√£o foi poss√≠vel carregar o an√∫ncio.</p>
          <button class="btn-gold" id="retry-btn">Tentar novamente</button>
        </div>
      </div>

      <div class="pause-row">
        <button class="ctrl-btn" id="pause-btn">Pausa</button>
      </div>
    </div>

    <!-- RESULTS SCREEN -->
    <div class="screen" id="results-screen">
      <div class="results-header">
        <h2>Resultados</h2>
      </div>
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-value" id="res-rounds">0</div>
          <div class="summary-label">Rondas</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="res-correct">0</div>
          <div class="summary-label">Corretas</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="res-accuracy">0%</div>
          <div class="summary-label">Precis√£o</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="res-time">0s</div>
          <div class="summary-label">Tempo m√©dio</div>
        </div>
      </div>
      <p class="best-streak-text">Melhor sequ√™ncia de sempre: <strong id="res-streak">0</strong></p>
      <div class="results-actions">
        <button class="action-btn primary" id="continue-btn">Continuar</button>
        <button class="action-btn secondary" id="restart-btn">Recome√ßar</button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-bottom">
      <div class="footer-legal">
        <a href="../legal/pt/terms.html">Termos e Condi√ß√µes</a>
        <a href="../legal/pt/privacy.html">Pol√≠tica de Privacidade</a>
        <a href="https://www.livroreclamacoes.pt/inicio/reclamacao?nipc=517747120" target="_blank">Livro de Reclama√ß√µes</a>
      </div>
      <p class="footer-copyright">&copy; <span class="current-year">2025</span> McMinsky. Todos os direitos reservados.</p>
    </div>
  </footer>

  <script src="../js/main.js"></script>
  <script>
    (function() {
      var STORAGE_KEY = 'mcminsky_precos_carros';
      var PROXY = 'https://api.allorigins.win/raw?url=';
      var BASE = 'https://auto.sapo.pt';
      var MAX_RETRIES = 3;

      /* --- DOM refs --- */
      var $ = function(id) { return document.getElementById(id); };
      var setupScreen = $('setup-screen');
      var gameScreen = $('game-screen');
      var resultsScreen = $('results-screen');
      var gameCard = $('game-card');
      var startBtn = $('start-btn');
      var resetLink = $('reset-link');
      var revealBtn = $('reveal-btn');
      var btnCorrect = $('btn-correct');
      var btnWrong = $('btn-wrong');
      var nextBtn = $('next-btn');
      var retryBtn = $('retry-btn');
      var pauseBtn = $('pause-btn');
      var continueBtn = $('continue-btn');
      var restartBtn = $('restart-btn');
      var streakVal = $('streak-val');
      var accuracyVal = $('accuracy-val');
      var roundNum = $('round-num');
      var streakFire = $('streak-fire');
      var timerDisplay = $('timer-display');
      var timerFinal = $('timer-final');
      var carImage = $('car-image');
      var carImageRevealed = $('car-image-revealed');
      var carImageNext = $('car-image-next');
      var priceValue = $('price-value');
      var priceNext = $('price-next');
      var listingLink = $('listing-link');
      var listingLinkNext = $('listing-link-next');
      var errorMessage = $('error-message');

      /* --- State --- */
      var data = loadData();
      var streak = 0;
      var sessionTotal = 0, sessionCorrect = 0, sessionTimes = [];
      var timerStart = 0, timerInterval = null;
      var currentPrice = '';
      var currentLink = '';
      var currentImageSrc = '';
      var retryCount = 0;

      /* --- Data persistence --- */
      function loadData() {
        try {
          var s = localStorage.getItem(STORAGE_KEY);
          if (s) return JSON.parse(s);
        } catch(e) {}
        return { totalRounds: 0, correct: 0, totalTime: 0, bestStreak: 0 };
      }

      function saveData() {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
      }

      /* --- Screens --- */
      function showScreen(name) {
        setupScreen.classList.remove('active');
        gameScreen.classList.remove('active');
        resultsScreen.classList.remove('active');
        if (name === 'setup') setupScreen.classList.add('active');
        else if (name === 'game') gameScreen.classList.add('active');
        else if (name === 'results') resultsScreen.classList.add('active');
      }

      function showGameState(stateId) {
        var states = gameCard.querySelectorAll('.game-state');
        for (var i = 0; i < states.length; i++) {
          states[i].classList.remove('active');
        }
        $(stateId).classList.add('active');
      }

      /* --- Setup stats --- */
      function updateSetupStats() {
        $('prev-rounds').textContent = data.totalRounds;
        var acc = data.totalRounds > 0 ? Math.round(data.correct / data.totalRounds * 100) : 0;
        $('prev-accuracy').textContent = acc + '%';
        $('prev-streak').textContent = data.bestStreak;
      }

      /* --- Timer --- */
      function startTimer() {
        timerStart = Date.now();
        timerDisplay.textContent = '0.0s';
        timerInterval = setInterval(function() {
          var elapsed = (Date.now() - timerStart) / 1000;
          timerDisplay.textContent = elapsed.toFixed(1) + 's';
        }, 100);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        return (Date.now() - timerStart) / 1000;
      }

      /* --- Stats bar --- */
      function updateStatsBar() {
        streakVal.textContent = streak;
        streakFire.classList.toggle('visible', streak >= 3);
        var acc = sessionTotal > 0 ? Math.round(sessionCorrect / sessionTotal * 100) : 0;
        accuracyVal.textContent = acc + '%';
        roundNum.textContent = sessionTotal;
      }

      /* --- Fetch a random car --- */
      function fetchCar() {
        showGameState('state-loading');
        retryCount = 0;
        attemptFetch();
      }

      function attemptFetch() {
        var page = Math.floor(Math.random() * 200) + 1;
        var targetUrl = BASE + '/carro/usado?p=' + page;
        var proxyUrl = PROXY + encodeURIComponent(targetUrl);

        fetch(proxyUrl)
          .then(function(res) {
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return res.text();
          })
          .then(function(html) {
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');
            var cards = doc.querySelectorAll('article.vehicle-card');
            if (!cards.length) throw new Error('No cards found');

            // Pick a random card
            var card = cards[Math.floor(Math.random() * cards.length)];

            // Extract image
            var imgEl = card.querySelector('.thumb img');
            if (!imgEl) throw new Error('No image');
            var imgSrc = imgEl.getAttribute('src') || '';
            if (imgSrc && imgSrc.indexOf('http') !== 0) imgSrc = BASE + imgSrc;

            // Extract link
            var linkEl = card.querySelector('.thumb a');
            var linkHref = linkEl ? (linkEl.getAttribute('href') || '') : '';
            if (linkHref && linkHref.indexOf('http') !== 0) linkHref = BASE + linkHref;

            // Extract price
            var priceEl = card.querySelector('.price span');
            if (!priceEl) throw new Error('No price');
            var price = priceEl.textContent.trim();

            if (!imgSrc || !price) throw new Error('Missing data');

            // Preload image
            preloadAndShow(imgSrc, price, linkHref);
          })
          .catch(function(err) {
            retryCount++;
            if (retryCount < MAX_RETRIES) {
              attemptFetch();
            } else {
              errorMessage.textContent = 'N√£o foi poss√≠vel carregar o an√∫ncio. (' + err.message + ')';
              showGameState('state-error');
            }
          });
      }

      function preloadAndShow(imgSrc, price, link) {
        var img = new Image();
        img.onload = function() {
          currentImageSrc = imgSrc;
          currentPrice = price;
          currentLink = link;

          // Set image on guessing screen
          carImage.src = imgSrc;
          carImage.classList.add('loaded');

          // Show guessing state and start timer ONLY after image loaded
          showGameState('state-guessing');
          startTimer();
        };
        img.onerror = function() {
          retryCount++;
          if (retryCount < MAX_RETRIES) {
            attemptFetch();
          } else {
            errorMessage.textContent = 'N√£o foi poss√≠vel carregar a imagem.';
            showGameState('state-error');
          }
        };
        img.src = imgSrc;
      }

      /* --- Game flow --- */
      function startGame() {
        showScreen('game');
        streak = 0;
        sessionTotal = 0;
        sessionCorrect = 0;
        sessionTimes = [];
        updateStatsBar();
        fetchCar();
      }

      function revealPrice() {
        var elapsed = stopTimer();
        sessionTimes.push(elapsed);

        // Setup revealed state
        carImageRevealed.src = currentImageSrc;
        carImageRevealed.classList.add('loaded');
        timerFinal.textContent = elapsed.toFixed(1) + 's';
        priceValue.textContent = currentPrice;
        listingLink.href = currentLink;

        showGameState('state-revealed');

        // Trigger price animation
        requestAnimationFrame(function() {
          priceValue.classList.add('revealed');
        });
      }

      function reportResult(correct) {
        sessionTotal++;
        data.totalRounds++;
        data.totalTime += sessionTimes[sessionTimes.length - 1] || 0;

        if (correct) {
          sessionCorrect++;
          data.correct++;
          streak++;
          if (streak > data.bestStreak) data.bestStreak = streak;
          gameCard.classList.add('correct-flash');
        } else {
          streak = 0;
          gameCard.classList.add('wrong-flash');
        }

        saveData();
        updateStatsBar();

        // Show next state
        carImageNext.src = currentImageSrc;
        carImageNext.classList.add('loaded');
        priceNext.textContent = currentPrice;
        listingLinkNext.href = currentLink;

        setTimeout(function() {
          gameCard.classList.remove('correct-flash');
          gameCard.classList.remove('wrong-flash');
          showGameState('state-next');
        }, 500);
      }

      function nextCar() {
        // Reset image states
        carImage.classList.remove('loaded');
        carImage.src = '';
        carImageRevealed.classList.remove('loaded');
        carImageNext.classList.remove('loaded');
        priceValue.classList.remove('revealed');
        fetchCar();
      }

      /* --- Results --- */
      function showResults() {
        showScreen('results');
        $('res-rounds').textContent = sessionTotal;
        $('res-correct').textContent = sessionCorrect;
        var acc = sessionTotal > 0 ? Math.round(sessionCorrect / sessionTotal * 100) : 0;
        $('res-accuracy').textContent = acc + '%';
        var avgT = sessionTimes.length > 0
          ? (sessionTimes.reduce(function(a,b){return a+b;},0) / sessionTimes.length).toFixed(1)
          : '0';
        $('res-time').textContent = avgT + 's';
        $('res-streak').textContent = data.bestStreak;
      }

      function pauseGame() {
        clearInterval(timerInterval);
        showResults();
      }

      /* --- Reset --- */
      function resetData() {
        if (!confirm('Tens a certeza que queres limpar todos os dados?')) return;
        data = { totalRounds: 0, correct: 0, totalTime: 0, bestStreak: 0 };
        saveData();
        updateSetupStats();
      }

      /* --- Init --- */
      function init() {
        updateSetupStats();

        startBtn.addEventListener('click', startGame);
        resetLink.addEventListener('click', resetData);
        revealBtn.addEventListener('click', revealPrice);
        btnCorrect.addEventListener('click', function() { reportResult(true); });
        btnWrong.addEventListener('click', function() { reportResult(false); });
        nextBtn.addEventListener('click', nextCar);
        retryBtn.addEventListener('click', function() {
          retryCount = 0;
          attemptFetch();
        });
        pauseBtn.addEventListener('click', pauseGame);

        continueBtn.addEventListener('click', function() {
          showScreen('game');
          fetchCar();
        });
        restartBtn.addEventListener('click', function() {
          showScreen('setup');
          updateSetupStats();
        });
      }

      init();
    })();
  </script>
</body>
</html>
